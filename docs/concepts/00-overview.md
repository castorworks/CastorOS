# CastorOS 概念文档

本目录包含 CastorOS 开发所需了解的核心概念和技术知识。

## 文档索引

| 文档 | 主题 | 描述 |
|------|------|------|
| [01-boot-process](01-boot-process.md) | 引导过程 | 从 GRUB 到内核启动的完整流程 |
| [02-higher-half-kernel](02-higher-half-kernel.md) | 高半核架构 | 内核地址空间布局和映射机制 |
| [03-memory-management](03-memory-management.md) | 内存管理 | PMM、VMM、堆分配器的设计与实现 |
| [04-interrupts](04-interrupts.md) | 中断与异常 | IDT、ISR、IRQ 处理机制 |
| [05-process-management](05-process-management.md) | 进程管理 | 任务结构、调度、上下文切换 |
| [06-synchronization](06-synchronization.md) | 同步原语 | 自旋锁、互斥锁、信号量 |
| [07-system-calls](07-system-calls.md) | 系统调用 | 用户态到内核态的接口 |
| [08-file-system](08-file-system.md) | 文件系统 | VFS 抽象层和具体文件系统 |
| [09-device-drivers](09-device-drivers.md) | 设备驱动 | 驱动模型和常见设备 |

## 架构概览

```
+------------------------------------------------------------------+
|                        User Space (0-2GB)                         |
|   +------------------+  +------------------+  +----------------+  |
|   |   User Program   |  |   User Program   |  |     Shell      |  |
|   +------------------+  +------------------+  +----------------+  |
+------------------------------------------------------------------+
                              | System Call (INT 0x80)
+------------------------------------------------------------------+
|                      Kernel Space (2GB-4GB)                       |
|  +------------------------------------------------------------+  |
|  |                    System Call Interface                    |  |
|  +------------------------------------------------------------+  |
|  |  Process  |  Memory   |   VFS    |  Network  |   Device    |  |
|  |  Manager  |  Manager  |  Layer   |   Stack   |   Drivers   |  |
|  +------------------------------------------------------------+  |
|  |                  Hardware Abstraction Layer                 |  |
|  +------------------------------------------------------------+  |
+------------------------------------------------------------------+
                              | I/O, IRQ, DMA
+------------------------------------------------------------------+
|                           Hardware                                |
|   CPU | Memory | Disk | Network | Keyboard | Timer | ACPI | ...   |
+------------------------------------------------------------------+
```

## 开发环境

- **目标平台**: x86 (i686)
- **编译器**: i686-elf-gcc (交叉编译)
- **汇编器**: NASM
- **引导加载器**: GRUB (Multiboot 规范)
- **测试环境**: QEMU

## 关键设计决策

### 1. 高半核设计
内核映射到虚拟地址 0x80000000 以上，用户空间使用 0-0x80000000。这简化了内核访问用户空间的实现。

### 2. 单地址空间内核
所有进程共享相同的内核映射（页目录的高半部分），减少 TLB 刷新开销。

### 3. Copy-on-Write (COW)
fork() 使用 COW 机制，父子进程共享物理页面直到写入时才复制。

### 4. 抢占式多任务
基于时钟中断的抢占式调度，支持用户态和内核态任务。

### 5. POSIX 兼容
系统调用接口尽量遵循 POSIX 规范，便于移植应用程序。

## 代码组织

```
src/
├── boot/           # 引导代码（汇编）
├── kernel/         # 内核核心
│   ├── sync/       # 同步原语
│   └── syscalls/   # 系统调用实现
├── mm/             # 内存管理
├── fs/             # 文件系统
├── drivers/        # 设备驱动
├── net/            # 网络栈
├── lib/            # 内核库函数
├── include/        # 头文件
└── tests/          # 内核测试
```

