# é˜¶æ®µ 7: æ–‡ä»¶ç³»ç»Ÿ

## æ¦‚è¿°

æœ¬é˜¶æ®µå°†å®ç° CastorOS çš„æ–‡ä»¶ç³»ç»Ÿæ”¯æŒï¼Œè¿™æ˜¯æ“ä½œç³»ç»Ÿèµ°å‘å®ç”¨åŒ–çš„å…³é”®ä¸€æ­¥ã€‚æˆ‘ä»¬å°†å®ç°è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰å±‚ä½œä¸ºç»Ÿä¸€æ¥å£ï¼Œå¹¶å®ç°åŸºäº RAM çš„ç®€å•æ–‡ä»¶ç³»ç»Ÿï¼ˆramfsï¼‰ã€‚é€šè¿‡æ–‡ä»¶ç³»ç»Ÿï¼Œç”¨æˆ·ç¨‹åºå¯ä»¥æŒä¹…åŒ–å­˜å‚¨æ•°æ®ï¼Œè®¿é—®ç³»ç»Ÿèµ„æºï¼Œå®ç°æ›´å¤æ‚çš„åŠŸèƒ½ã€‚

**ğŸ“ è®¾è®¡ç†å¿µ**ï¼š

æœ¬æ–‡æ¡£é‡‡ç”¨äº†**åˆ†å±‚æ–‡ä»¶ç³»ç»Ÿæ¶æ„**ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

âœ… **è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰å±‚**
   - æä¾›ç»Ÿä¸€çš„æ–‡ä»¶æ“ä½œæ¥å£
   - æ”¯æŒå¤šç§æ–‡ä»¶ç³»ç»Ÿç±»å‹
   - æ˜“äºæ‰©å±•æ–°çš„æ–‡ä»¶ç³»ç»Ÿ

âœ… **ramfs æ–‡ä»¶ç³»ç»Ÿ**
   - è½»é‡çº§ã€æ˜“äºå®ç°
   - å†…å­˜ä¸­è¿è¡Œï¼Œè®¿é—®å¿«é€Ÿ
   - é€‚åˆå­˜å‚¨å¯åŠ¨æ‰€éœ€çš„æ–‡ä»¶

âœ… **è®¾å¤‡æ–‡ä»¶ç³»ç»Ÿï¼ˆdevfsï¼‰**
   - ç»Ÿä¸€çš„è®¾å¤‡è®¿é—®æ¥å£
   - ä¸€åˆ‡çš†æ–‡ä»¶çš„ Unix å“²å­¦
   - ç®€åŒ–è®¾å¤‡é©±åŠ¨æ¥å£

âœ… **è·¯å¾„è§£æå’ŒæŒ‚è½½æœºåˆ¶**
   - æ”¯æŒç»å¯¹è·¯å¾„å’Œç›¸å¯¹è·¯å¾„
   - çµæ´»çš„æ–‡ä»¶ç³»ç»ŸæŒ‚è½½
   - ç›®å½•å±‚æ¬¡ç»“æ„

è¿™ç§æ¶æ„ä¸ºæœªæ¥æ”¯æŒæ›´å¤æ‚çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ FAT32ã€ext2ï¼‰å’Œè®¾å¤‡ç®¡ç†å¥ å®šäº†è‰¯å¥½åŸºç¡€ã€‚

---

## ç›®æ ‡

- âœ… è®¾è®¡å¹¶å®ç°è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰å±‚
- âœ… å®ç° ramfsï¼ˆåŸºäº RAM çš„ç®€å•æ–‡ä»¶ç³»ç»Ÿï¼‰
- âœ… å®ç°åŸºæœ¬æ–‡ä»¶æ“ä½œï¼ˆopenã€closeã€readã€writeï¼‰
- âœ… å®ç°ç›®å½•æ“ä½œï¼ˆreaddirã€mkdirï¼‰
- âœ… å®ç°è®¾å¤‡æ–‡ä»¶ç³»ç»Ÿï¼ˆdevfsï¼‰
- âœ… å®ç°è·¯å¾„è§£æå’Œæ–‡ä»¶æŸ¥æ‰¾
- âœ… å®ç°æ–‡ä»¶ç³»ç»ŸæŒ‚è½½æœºåˆ¶
- âœ… æ›´æ–° kernel shell å‘½ä»¤ï¼Œæ”¯æŒæ–‡ä»¶æ“ä½œ

---

## æŠ€æœ¯èƒŒæ™¯

### ä»€ä¹ˆæ˜¯æ–‡ä»¶ç³»ç»Ÿï¼Ÿ

**æ–‡ä»¶ç³»ç»Ÿï¼ˆFile Systemï¼‰** æ˜¯æ“ä½œç³»ç»Ÿç”¨äºç»„ç»‡ã€å­˜å‚¨å’Œè®¿é—®æ•°æ®çš„æ–¹æ³•ã€‚å®ƒæä¾›äº†ä¸€ç§å°†æ•°æ®ç»„ç»‡æˆæ–‡ä»¶å’Œç›®å½•çš„æŠ½è±¡ã€‚

**æ–‡ä»¶ç³»ç»Ÿçš„æ ¸å¿ƒæ¦‚å¿µ**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Shell / Applications               â”‚
â”‚  (vfs_path_to_node, vfs_read, etc.)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Virtual File System (VFS)            â”‚
â”‚  - Unified Interface                    â”‚
â”‚  - Path Resolution                      â”‚
â”‚  - Mount Mechanism                      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ramfs     â”‚  â”‚   devfs       â”‚
â”‚  (Memory)   â”‚  â”‚   (Devices)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆéœ€è¦æ–‡ä»¶ç³»ç»Ÿï¼Ÿ**

1. **æ•°æ®æŒä¹…åŒ–**ï¼šç¨‹åºé€€å‡ºåæ•°æ®ä»ç„¶ä¿ç•™
2. **æ•°æ®ç»„ç»‡**ï¼šå°†ç›¸å…³æ–‡ä»¶ç»„ç»‡æˆç›®å½•
3. **èµ„æºå…±äº«**ï¼šå¤šä¸ªè¿›ç¨‹å¯ä»¥è®¿é—®åŒä¸€æ–‡ä»¶
4. **è®¾å¤‡æŠ½è±¡**ï¼šç»Ÿä¸€è®¿é—®å­˜å‚¨è®¾å¤‡å’Œå…¶ä»–è®¾å¤‡
5. **æƒé™æ§åˆ¶**ï¼šç®¡ç†æ–‡ä»¶çš„è®¿é—®æƒé™

---

### è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰

**VFS** æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­çš„ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œå®ƒä¸ºä¸åŒç±»å‹çš„æ–‡ä»¶ç³»ç»Ÿæä¾›ç»Ÿä¸€çš„æ¥å£ã€‚

**VFS çš„ä¼˜åŠ¿**ï¼š

```
åº”ç”¨ç¨‹åºåªéœ€è¦çŸ¥é“ï¼š
  vfs_path_to_node("/path/to/file")
  
è€Œä¸éœ€è¦å…³å¿ƒï¼š
  - æ–‡ä»¶åœ¨ ramfs è¿˜æ˜¯ç¡¬ç›˜ä¸Šï¼Ÿ
  - ä½¿ç”¨çš„æ˜¯ ramfs è¿˜æ˜¯å…¶ä»–æ–‡ä»¶ç³»ç»Ÿï¼Ÿ
  - æ˜¯çœŸå®æ–‡ä»¶è¿˜æ˜¯è®¾å¤‡æ–‡ä»¶ï¼Ÿ
```

**VFS çš„æ ¸å¿ƒæ•°æ®ç»“æ„**ï¼š

1. **inodeï¼ˆç´¢å¼•èŠ‚ç‚¹ï¼‰**
   - è¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•
   - åŒ…å«æ–‡ä»¶å…ƒæ•°æ®ï¼ˆå¤§å°ã€æƒé™ã€æ—¶é—´æˆ³ç­‰ï¼‰
   - ä¸åŒ…å«æ–‡ä»¶åï¼ˆæ–‡ä»¶ååœ¨ç›®å½•é¡¹ä¸­ï¼‰

2. **dentryï¼ˆç›®å½•é¡¹ï¼‰**
   - è¡¨ç¤ºæ–‡ä»¶ååˆ° inode çš„æ˜ å°„
   - å®ç°ç›®å½•å±‚æ¬¡ç»“æ„
   - ç”¨äºè·¯å¾„è§£æ

3. **fileï¼ˆæ–‡ä»¶å¯¹è±¡ï¼‰**
   - è¡¨ç¤ºä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶
   - åŒ…å«å½“å‰è¯»å†™ä½ç½®
   - æŒ‡å‘å¯¹åº”çš„ inode

4. **superblockï¼ˆè¶…çº§å—ï¼‰**
   - è¡¨ç¤ºä¸€ä¸ªæŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿ
   - åŒ…å«æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®
   - æä¾›æ–‡ä»¶ç³»ç»Ÿæ“ä½œå‡½æ•°

---

### ramfsï¼ˆRAM æ–‡ä»¶ç³»ç»Ÿï¼‰

**ramfs** æ˜¯ä¸€ä¸ªå®Œå…¨åŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨åœ¨ RAM ä¸­ã€‚

**ä¸ºä»€ä¹ˆä½¿ç”¨ ramfsï¼Ÿ**

1. **ç®€å•å®ç°**ï¼šæ¯”å®ç°å®Œæ•´çš„ç£ç›˜æ–‡ä»¶ç³»ç»Ÿç®€å•å¾—å¤š
2. **å¿«é€Ÿè®¿é—®**ï¼šåœ¨å†…å­˜ä¸­ï¼Œè®¿é—®é€Ÿåº¦æå¿«
3. **åŠ¨æ€åˆ†é…**ï¼šæ–‡ä»¶å¤§å°å¯ä»¥åŠ¨æ€å¢é•¿
4. **ç‹¬ç«‹æ€§**ï¼šä¸ä¾èµ–ç¡¬ç›˜é©±åŠ¨
5. **å¯å†™æ€§**ï¼šæ”¯æŒå®Œæ•´çš„è¯»å†™æ“ä½œ

**ramfs çš„ç‰¹æ€§**ï¼š

- **å®Œå…¨åœ¨å†…å­˜ä¸­**ï¼šæ‰€æœ‰æ–‡ä»¶æ•°æ®å­˜å‚¨åœ¨å †å†…å­˜ä¸­
- **åŠ¨æ€æ‰©å®¹**ï¼šæ–‡ä»¶å†™å…¥æ—¶è‡ªåŠ¨åˆ†é…å†…å­˜
- **æ”¯æŒç›®å½•å±‚æ¬¡**ï¼šå®Œæ•´çš„ç›®å½•ç»“æ„æ”¯æŒ
- **æ”¯æŒæ–‡ä»¶æ“ä½œ**ï¼šåˆ›å»ºã€è¯»å–ã€å†™å…¥ã€åˆ é™¤æ–‡ä»¶

---

### è®¾å¤‡æ–‡ä»¶ç³»ç»Ÿï¼ˆdevfsï¼‰

**devfs** å°†è®¾å¤‡æ˜ å°„ä¸ºæ–‡ä»¶ï¼Œå®ç° "ä¸€åˆ‡çš†æ–‡ä»¶" çš„ Unix å“²å­¦ã€‚

**è®¾å¤‡æ–‡ä»¶ç±»å‹**ï¼š

1. **å­—ç¬¦è®¾å¤‡**ï¼šæŒ‰å­—ç¬¦è®¿é—®ï¼ˆå¦‚é”®ç›˜ã€ä¸²å£ï¼‰
2. **å—è®¾å¤‡**ï¼šæŒ‰å—è®¿é—®ï¼ˆå¦‚ç¡¬ç›˜ï¼‰

**devfs çš„ä¼˜åŠ¿**ï¼š

```c
// ä¸éœ€è¦ç‰¹æ®Šçš„è®¾å¤‡ API
read(fd_keyboard, buffer, size);

// è€Œä¸æ˜¯
keyboard_read(buffer, size);
```

**å…¸å‹çš„ /dev ç›®å½•**ï¼š

```
/dev/
  â”œâ”€â”€ null      # ç©ºè®¾å¤‡ï¼ˆè¯»è¿”å›0ï¼Œå†™ä¸¢å¼ƒæ•°æ®ï¼‰
  â”œâ”€â”€ zero      # é›¶è®¾å¤‡ï¼ˆè¯»è¿”å›é›¶å­—èŠ‚ï¼‰
  â”œâ”€â”€ serial    # ä¸²å£è®¾å¤‡ï¼ˆCOM1ï¼Œæ”¯æŒè¯»å†™ï¼‰
  â””â”€â”€ console   # æ§åˆ¶å°è®¾å¤‡ï¼ˆé”®ç›˜è¾“å…¥ï¼ŒVGAè¾“å‡ºï¼‰
```

---

## æ–‡ä»¶ç³»ç»Ÿè®¾è®¡

### 1. VFS å±‚è®¾è®¡

#### æ ¸å¿ƒæ•°æ®ç»“æ„

**inode ç»“æ„**ï¼š

```c
// æ–‡ä»¶ç±»å‹
typedef enum {
    FS_FILE,        // æ™®é€šæ–‡ä»¶
    FS_DIRECTORY,   // ç›®å½•
    FS_CHARDEVICE,  // å­—ç¬¦è®¾å¤‡
    FS_BLOCKDEVICE, // å—è®¾å¤‡
    FS_PIPE,        // ç®¡é“
    FS_SYMLINK,     // ç¬¦å·é“¾æ¥
} fs_node_type_t;

// inodeï¼ˆæ–‡ä»¶èŠ‚ç‚¹ï¼‰
typedef struct fs_node {
    char name[128];              // æ–‡ä»¶å
    uint32_t inode;              // inode ç¼–å·
    fs_node_type_t type;         // æ–‡ä»¶ç±»å‹
    uint32_t size;               // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    uint32_t permissions;        // æƒé™
    uint32_t uid;                // ç”¨æˆ· ID
    uint32_t gid;                // ç»„ ID
    uint32_t flags;              // æ ‡å¿—ä½
    
    uint32_t impl;               // å®ç°ç›¸å…³æ•°æ®ï¼ˆæŒ‡é’ˆï¼‰
    
    // æ–‡ä»¶æ“ä½œå‡½æ•°æŒ‡é’ˆ
    read_type_t read;
    write_type_t write;
    open_type_t open;
    close_type_t close;
    readdir_type_t readdir;
    finddir_type_t finddir;
    create_type_t create;
    mkdir_type_t mkdir;
    unlink_type_t unlink;
    
    struct fs_node *ptr;         // ç”¨äºç¬¦å·é“¾æ¥å’ŒæŒ‚è½½ç‚¹
} fs_node_t;
```

**æ–‡ä»¶æ“ä½œå‡½æ•°ç±»å‹**ï¼š

```c
typedef uint32_t (*read_type_t)(fs_node_t *node, uint32_t offset, 
                                uint32_t size, uint8_t *buffer);
typedef uint32_t (*write_type_t)(fs_node_t *node, uint32_t offset,
                                 uint32_t size, uint8_t *buffer);
typedef void (*open_type_t)(struct fs_node *node, uint32_t flags);
typedef void (*close_type_t)(struct fs_node *node);
typedef struct dirent *(*readdir_type_t)(struct fs_node *node, uint32_t index);
typedef struct fs_node *(*finddir_type_t)(struct fs_node *node, const char *name);
typedef int (*create_type_t)(struct fs_node *node, const char *name);
typedef int (*mkdir_type_t)(struct fs_node *node, const char *name, uint32_t permissions);
typedef int (*unlink_type_t)(struct fs_node *node, const char *name);
```

**ç›®å½•é¡¹ç»“æ„**ï¼š

```c
struct dirent {
    char d_name[128];     // æ–‡ä»¶å
    uint32_t d_ino;       // inode ç¼–å·
    uint16_t d_reclen;    // è®°å½•é•¿åº¦
    uint16_t d_type;       // æ–‡ä»¶ç±»å‹ï¼ˆDT_REG, DT_DIR, DT_CHR ç­‰ï¼‰
    uint32_t d_off;        // åç§»é‡
};
```

**VFS æ ¸å¿ƒå‡½æ•°**ï¼š

```c
// è·¯å¾„è§£æ
fs_node_t *vfs_path_to_node(const char *path);

// æ–‡ä»¶æ“ä½œ
uint32_t vfs_read(fs_node_t *node, uint32_t offset, uint32_t size, uint8_t *buffer);
uint32_t vfs_write(fs_node_t *node, uint32_t offset, uint32_t size, uint8_t *buffer);
void vfs_open(fs_node_t *node, uint32_t flags);
void vfs_close(fs_node_t *node);

// ç›®å½•æ“ä½œ
struct dirent *vfs_readdir(fs_node_t *node, uint32_t index);
fs_node_t *vfs_finddir(fs_node_t *node, const char *name);

// æ–‡ä»¶ç³»ç»Ÿæ“ä½œ
int vfs_create(const char *path);
int vfs_mkdir(const char *path, uint32_t permissions);
int vfs_unlink(const char *path);
int vfs_mount(const char *path, fs_node_t *root);
```

---

## å®ç°æ­¥éª¤

### æ­¥éª¤ 1ï¼šåˆ›å»º VFS å±‚

**æ–‡ä»¶**: `src/include/fs/vfs.h`
**æ–‡ä»¶**: `src/fs/vfs.c`

VFS å±‚æä¾›äº†ç»Ÿä¸€çš„æ–‡ä»¶ç³»ç»Ÿæ¥å£ï¼ŒåŒ…æ‹¬ï¼š
- è·¯å¾„è§£æï¼ˆ`vfs_path_to_node`ï¼‰
- æ–‡ä»¶æ“ä½œï¼ˆreadã€writeã€openã€closeï¼‰
- ç›®å½•æ“ä½œï¼ˆreaddirã€finddirï¼‰
- æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼ˆcreateã€mkdirã€unlinkï¼‰
- æŒ‚è½½æœºåˆ¶ï¼ˆ`vfs_mount`ï¼‰

---

### æ­¥éª¤ 2ï¼šå®ç° ramfs æ–‡ä»¶ç³»ç»Ÿ

**æ–‡ä»¶**: `src/include/fs/ramfs.h`
**æ–‡ä»¶**: `src/fs/ramfs.c`

ramfs æ˜¯ä¸€ä¸ªå®Œå…¨åŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå®ç°åŒ…æ‹¬ï¼š

- **æ–‡ä»¶æ•°æ®ç»“æ„**ï¼šä½¿ç”¨åŠ¨æ€åˆ†é…çš„å†…å­˜å­˜å‚¨æ–‡ä»¶æ•°æ®
- **ç›®å½•ç»“æ„**ï¼šä½¿ç”¨é“¾è¡¨å­˜å‚¨ç›®å½•é¡¹
- **æ–‡ä»¶æ“ä½œ**ï¼šæ”¯æŒåˆ›å»ºã€è¯»å–ã€å†™å…¥ã€åˆ é™¤æ–‡ä»¶
- **ç›®å½•æ“ä½œ**ï¼šæ”¯æŒåˆ›å»ºã€åˆ é™¤ç›®å½•ï¼Œè¯»å–ç›®å½•é¡¹

**ramfs æ ¸å¿ƒå‡½æ•°**ï¼š

```c
// åˆå§‹åŒ– ramfsï¼Œåˆ›å»ºæ ¹æ–‡ä»¶ç³»ç»Ÿ
fs_node_t *ramfs_init(void);

// åˆ›å»ºæ–°çš„ ramfs æŒ‚è½½ç‚¹
fs_node_t *ramfs_create(const char *name);
```

---

### æ­¥éª¤ 3ï¼šå®ç° devfs æ–‡ä»¶ç³»ç»Ÿ

**æ–‡ä»¶**: `src/include/fs/devfs.h`
**æ–‡ä»¶**: `src/fs/devfs.c`

devfs æä¾›è®¾å¤‡æ–‡ä»¶æ¥å£ï¼Œå½“å‰å®ç°åŒ…æ‹¬ 4 ä¸ªè®¾å¤‡ï¼š

1. **/dev/null** - ç©ºè®¾å¤‡
   - è¯»å–ï¼šæ€»æ˜¯è¿”å› 0 å­—èŠ‚
   - å†™å…¥ï¼šæ€»æ˜¯æˆåŠŸï¼Œä½†ä¸¢å¼ƒæ•°æ®

2. **/dev/zero** - é›¶è®¾å¤‡
   - è¯»å–ï¼šè¿”å›æŒ‡å®šå¤§å°çš„é›¶å­—èŠ‚
   - å†™å…¥ï¼šæ€»æ˜¯æˆåŠŸ

3. **/dev/serial** - ä¸²å£è®¾å¤‡ï¼ˆCOM1ï¼‰
   - è¯»å–ï¼šéé˜»å¡è¯»å–ä¸²å£æ•°æ®
   - å†™å…¥ï¼šå°†æ•°æ®å‘é€åˆ°ä¸²å£

4. **/dev/console** - æ§åˆ¶å°è®¾å¤‡
   - è¯»å–ï¼šä»é”®ç›˜è¯»å–è¾“å…¥ï¼ˆéé˜»å¡ï¼‰
   - å†™å…¥ï¼šè¾“å‡ºåˆ° VGA æ§åˆ¶å°

**devfs æ ¸å¿ƒå‡½æ•°**ï¼š

```c
// åˆå§‹åŒ– devfsï¼Œè¿”å› /dev æ ¹ç›®å½•èŠ‚ç‚¹
fs_node_t *devfs_init(void);
```

---

### æ­¥éª¤ 4ï¼šåœ¨å†…æ ¸å¯åŠ¨æ—¶åˆå§‹åŒ–æ–‡ä»¶ç³»ç»Ÿ

ä¿®æ”¹ `src/kernel/kernel.c` ä¸­çš„ `fs_init()` å‡½æ•°ï¼š

```c
#include <fs/vfs.h>
#include <fs/ramfs.h>
#include <fs/devfs.h>

void fs_init(void) {
    // åˆå§‹åŒ– VFS
    vfs_init();
    
    // åˆå§‹åŒ– RAMFS
    fs_node_t *root = ramfs_init();
    if (!root) {
        LOG_ERROR_MSG("Failed to initialize RAMFS\n");
        return;
    }
    LOG_INFO_MSG("RAMFS initialized\n");
    
    // è®¾ç½® RAMFS ä¸ºæ ¹æ–‡ä»¶ç³»ç»Ÿ
    vfs_set_root(root);

    // åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»º /dev ç›®å½•
    if (vfs_mkdir("/dev", FS_PERM_READ | FS_PERM_WRITE | FS_PERM_EXEC) != 0) {
        LOG_ERROR_MSG("Failed to create /dev directory\n");
        return;
    }
    LOG_INFO_MSG("/dev directory created\n");

    // åˆå§‹åŒ– devfs
    fs_node_t *devfs_root = devfs_init();
    if (!devfs_root) {
        LOG_ERROR_MSG("Failed to initialize devfs\n");
        return;
    }
    LOG_INFO_MSG("devfs initialized\n");
    
    // å°† devfs æŒ‚è½½åˆ° /dev
    if (vfs_mount("/dev", devfs_root) != 0) {
        LOG_ERROR_MSG("Failed to mount devfs to /dev\n");
        return;
    }
    LOG_INFO_MSG("devfs mounted at /dev\n");
}
```

---

## Shell å‘½ä»¤å®ç°

å†…æ ¸ Shell å·²å®ç°äº†å®Œæ•´çš„æ–‡ä»¶æ“ä½œå‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤ç›´æ¥ä½¿ç”¨ VFS æ¥å£ï¼š

### å·²å®ç°çš„æ–‡ä»¶æ“ä½œå‘½ä»¤

1. **ls** - åˆ—å‡ºç›®å½•å†…å®¹
   - ç”¨æ³•ï¼š`ls [path]`
   - åŠŸèƒ½ï¼šæ˜¾ç¤ºæŒ‡å®šç›®å½•ï¼ˆæˆ–å½“å‰ç›®å½•ï¼‰ä¸­çš„æ–‡ä»¶å’Œå­ç›®å½•
   - æ”¯æŒæ˜¾ç¤ºæ–‡ä»¶ç±»å‹å’Œå¤§å°

2. **cat** - æ˜¾ç¤ºæ–‡ä»¶å†…å®¹
   - ç”¨æ³•ï¼š`cat <file>`
   - åŠŸèƒ½ï¼šè¯»å–å¹¶æ˜¾ç¤ºæ–‡ä»¶å†…å®¹
   - æ”¯æŒå¸¸è§„æ–‡ä»¶å’Œè®¾å¤‡æ–‡ä»¶

3. **touch** - åˆ›å»ºç©ºæ–‡ä»¶
   - ç”¨æ³•ï¼š`touch <file>`
   - åŠŸèƒ½ï¼šåœ¨æŒ‡å®šè·¯å¾„åˆ›å»ºç©ºæ–‡ä»¶

4. **write** - å†™å…¥æ–‡ä»¶
   - ç”¨æ³•ï¼š`write <file> <text...>`
   - åŠŸèƒ½ï¼šå°†æ–‡æœ¬å†…å®¹å†™å…¥æ–‡ä»¶ï¼ˆè¦†ç›–æ¨¡å¼ï¼‰
   - æ”¯æŒå¸¸è§„æ–‡ä»¶å’Œè®¾å¤‡æ–‡ä»¶

5. **rm** - åˆ é™¤æ–‡ä»¶
   - ç”¨æ³•ï¼š`rm <file>`
   - åŠŸèƒ½ï¼šåˆ é™¤æŒ‡å®šæ–‡ä»¶

6. **mkdir** - åˆ›å»ºç›®å½•
   - ç”¨æ³•ï¼š`mkdir <dir>`
   - åŠŸèƒ½ï¼šåœ¨æŒ‡å®šè·¯å¾„åˆ›å»ºç›®å½•

7. **rmdir** - åˆ é™¤ç›®å½•
   - ç”¨æ³•ï¼š`rmdir <dir>`
   - åŠŸèƒ½ï¼šåˆ é™¤ç©ºç›®å½•

8. **pwd** - æ˜¾ç¤ºå½“å‰å·¥ä½œç›®å½•
   - ç”¨æ³•ï¼š`pwd`
   - åŠŸèƒ½ï¼šæ˜¾ç¤ºå½“å‰å·¥ä½œç›®å½•è·¯å¾„

9. **cd** - åˆ‡æ¢ç›®å½•
   - ç”¨æ³•ï¼š`cd [path]`
   - åŠŸèƒ½ï¼šåˆ‡æ¢åˆ°æŒ‡å®šç›®å½•ï¼ˆæ”¯æŒç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„ï¼‰
   - æ”¯æŒ `.` å’Œ `..` è·¯å¾„è§£æ

### è®¾å¤‡æ–‡ä»¶ä½¿ç”¨ç¤ºä¾‹

**ä½¿ç”¨ /dev/serial è®¾å¤‡**ï¼š

```c
// åœ¨ Shell ä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨
$ write /dev/serial "Hello, Serial Port!\n"
$ cat /dev/serial  # è¯»å–ä¸²å£æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
```

**ä½¿ç”¨ /dev/console è®¾å¤‡**ï¼š

```c
// å†™å…¥åˆ°æ§åˆ¶å°ï¼ˆVGA è¾“å‡ºï¼‰
$ write /dev/console "Hello, Console!\n"

// ä»æ§åˆ¶å°è¯»å–ï¼ˆé”®ç›˜è¾“å…¥ï¼‰
$ cat /dev/console
```

**ä½¿ç”¨ /dev/null å’Œ /dev/zero**ï¼š

```c
// å†™å…¥åˆ° /dev/nullï¼ˆæ•°æ®è¢«ä¸¢å¼ƒï¼‰
$ write /dev/null "This will be discarded\n"

// ä» /dev/zero è¯»å–ï¼ˆè·å–é›¶å­—èŠ‚ï¼‰
$ cat /dev/zero  # ä¼šè¾“å‡ºé›¶å­—èŠ‚
```

---

## å®ç°ç»†èŠ‚

### è·¯å¾„è§£æ

Shell å®ç°äº†å®Œæ•´çš„è·¯å¾„è§£æåŠŸèƒ½ï¼š

- **ç»å¯¹è·¯å¾„**ï¼šä»¥ `/` å¼€å¤´çš„è·¯å¾„
- **ç›¸å¯¹è·¯å¾„**ï¼šç›¸å¯¹äºå½“å‰å·¥ä½œç›®å½•çš„è·¯å¾„
- **è·¯å¾„è§„èŒƒåŒ–**ï¼šè‡ªåŠ¨å¤„ç† `.` å’Œ `..`
- **è·¯å¾„è§£æå‡½æ•°**ï¼š`shell_resolve_path()` å’Œ `shell_normalize_path()`

### æŒ‚è½½æœºåˆ¶

VFS æ”¯æŒæ–‡ä»¶ç³»ç»ŸæŒ‚è½½ï¼š

- **æŒ‚è½½ç‚¹**ï¼šå¿…é¡»æ˜¯å·²å­˜åœ¨çš„ç›®å½•èŠ‚ç‚¹
- **æŒ‚è½½å®ç°**ï¼šä½¿ç”¨ `fs_node_t->ptr` å­—æ®µå­˜å‚¨æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿæ ¹èŠ‚ç‚¹
- **æŒ‚è½½æ£€æŸ¥**ï¼šåœ¨ `vfs_readdir()` å’Œ `vfs_finddir()` ä¸­è‡ªåŠ¨å¤„ç†æŒ‚è½½ç‚¹

### æ–‡ä»¶ç³»ç»Ÿæ“ä½œ

ramfs å®ç°äº†å®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼š

- **æ–‡ä»¶åˆ›å»º**ï¼šåŠ¨æ€åˆ†é…å†…å­˜å­˜å‚¨æ–‡ä»¶æ•°æ®
- **æ–‡ä»¶å†™å…¥**ï¼šè‡ªåŠ¨æ‰©å®¹ï¼ŒæŒ‰ 4KB å¯¹é½
- **ç›®å½•ç®¡ç†**ï¼šä½¿ç”¨é“¾è¡¨å­˜å‚¨ç›®å½•é¡¹
- **èµ„æºé‡Šæ”¾**ï¼šåˆ é™¤æ–‡ä»¶æ—¶è‡ªåŠ¨é‡Šæ”¾å†…å­˜

---
