# é˜¶æ®µ 14: IBM ThinkPad T41 æ˜¾å¡é©±åŠ¨

## æ¦‚è¿°

æœ¬é˜¶æ®µä¸º IBM ThinkPad T41 ç¬”è®°æœ¬ç”µè„‘å®ç°å›¾å½¢æ˜¾ç¤ºæ”¯æŒã€‚T41 ç³»åˆ—é…å¤‡ ATI Mobility Radeon 7500/9000 æ˜¾å¡ï¼Œæ”¯æŒä¸¤ç§å±å¹•é…ç½®ï¼š

- **XGA å‹å·**ï¼š1024Ã—768 åˆ†è¾¨ç‡
- **SXGA+ å‹å·**ï¼š1400Ã—1050 åˆ†è¾¨ç‡

æœ¬é˜¶æ®µå®ç°äº†ä» VGA æ–‡æœ¬æ¨¡å¼ï¼ˆ80Ã—25ï¼‰åˆ°å›¾å½¢æ¨¡å¼çš„å®Œæ•´å‡çº§ï¼Œå¹¶**è‡ªåŠ¨é€‚é…ä¸åŒåˆ†è¾¨ç‡çš„å±å¹•**ã€‚

**ğŸ“ è®¾è®¡ç†å¿µ**ï¼š

æœ¬é˜¶æ®µé‡‡ç”¨**æ¸è¿›å¼å›¾å½¢æ”¯æŒ**æ¶æ„ï¼š

âœ… **PCI æ€»çº¿é©±åŠ¨** - å·²å®ç°
   - PCI é…ç½®ç©ºé—´è®¿é—®
   - è®¾å¤‡æšä¸¾ä¸èµ„æºåˆ†é…
   - ä¸ºæ˜¾å¡å’Œå…¶ä»– PCI è®¾å¤‡æä¾›ç»Ÿä¸€è®¿é—®æ¥å£

âœ… **VESA VBE å¸§ç¼“å†²** - å·²å®ç°
   - é€šè¿‡ GRUB è®¾ç½®å›¾å½¢æ¨¡å¼
   - Multiboot ä¿¡æ¯è·å–å¸§ç¼“å†²åœ°å€
   - ç¡¬ä»¶æ— å…³çš„åŸºç¡€å›¾å½¢æ¨¡å¼

âœ… **å¸§ç¼“å†²æŠ½è±¡å±‚** - å·²å®ç°
   - ç»Ÿä¸€çš„å›¾å½¢æ“ä½œæ¥å£
   - åƒç´ ç»˜åˆ¶ã€çŸ©å½¢å¡«å……ã€ä½å›¾ä¼ è¾“
   - ç»ˆç«¯ä»¿çœŸï¼ˆæ›¿ä»£ VGA æ–‡æœ¬æ¨¡å¼ï¼‰
   - ANSI è½¬ä¹‰åºåˆ—æ”¯æŒ

âœ… **æ€§èƒ½ä¼˜åŒ–** - å·²å®ç°
   - PAT (Page Attribute Table) Write-Combining æ”¯æŒ
   - è½¯ä»¶åŒç¼“å†²ä¼˜åŒ–æ»šå±æ€§èƒ½

â¬œ **ATI Radeon åŸºç¡€é©±åŠ¨**ï¼ˆå¯é€‰ï¼Œæœªå®ç°ï¼‰
   - ç›´æ¥è®¿é—®æ˜¾å¡å¯„å­˜å™¨
   - æ¨¡å¼è®¾ç½®ï¼ˆModesettingï¼‰
   - 2D åŠ é€Ÿæ“ä½œ

---

## ç›®æ ‡å®Œæˆæƒ…å†µ

- [x] å®ç° PCI æ€»çº¿æšä¸¾å’Œé…ç½®ç©ºé—´è®¿é—®
- [x] å®ç° VESA VBE å›¾å½¢æ¨¡å¼è®¾ç½®ï¼ˆé€šè¿‡ GRUBï¼‰
- [x] å®ç°å¸§ç¼“å†²é©±åŠ¨æŠ½è±¡å±‚
- [x] å®ç°åŸºç¡€å›¾å½¢æ“ä½œï¼ˆåƒç´ ã€çº¿æ¡ã€çŸ©å½¢ã€å­—ç¬¦æ¸²æŸ“ï¼‰
- [x] æ”¯æŒå¤šåˆ†è¾¨ç‡ï¼š1024Ã—768 å’Œ 1400Ã—1050ï¼ˆ32bppï¼‰
- [x] å®ç° EDID è§£æï¼ˆè¯»å–åŠŸèƒ½éœ€è¦ I2C ç¡¬ä»¶æ”¯æŒï¼‰
- [x] å®ç°å›¾å½¢ç»ˆç«¯ä»¿çœŸï¼ˆæ›¿ä»£ VGA æ–‡æœ¬æ¨¡å¼ï¼‰
- [x] å®ç° ANSI è½¬ä¹‰åºåˆ—æ”¯æŒï¼ˆé¢œè‰²ã€å…‰æ ‡ã€æ¸…å±ï¼‰
- [x] å®ç° PAT Write-Combining æ€§èƒ½ä¼˜åŒ–
- [x] å®ç°è½¯ä»¶åŒç¼“å†²ä¼˜åŒ–
- [ ] ï¼ˆå¯é€‰ï¼‰ATI Radeon 7500/9000 åŸç”Ÿé©±åŠ¨

---

## å®ç°æ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åº”ç”¨å±‚                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚   kernel_shell  â”‚  â”‚   userland/shellâ”‚  â”‚   kprintf      â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                    â”‚                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç»ˆç«¯æŠ½è±¡å±‚                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚              fb_terminal_putchar()                      â”‚   â”‚
â”‚   â”‚        æ”¯æŒ ANSI è½¬ä¹‰åºåˆ— / VGA é¢œè‰²å…¼å®¹                  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¸§ç¼“å†²é©±åŠ¨å±‚                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ åŸºç¡€ç»˜å›¾å‡½æ•°  â”‚  â”‚  æ–‡æœ¬æ¸²æŸ“    â”‚  â”‚    åŒç¼“å†²æ”¯æŒ        â”‚  â”‚
â”‚   â”‚ fb_put_pixel â”‚  â”‚ fb_draw_char â”‚  â”‚ back_buffer_mem      â”‚  â”‚
â”‚   â”‚ fb_fill_rect â”‚  â”‚ fb_draw_str  â”‚  â”‚ fb_flush()           â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å†…å­˜æ˜ å°„å±‚                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚              vmm_map_framebuffer()                      â”‚   â”‚
â”‚   â”‚        PAT Write-Combining æ¨¡å¼ (é«˜æ€§èƒ½)                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç¡¬ä»¶å±‚                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚              çº¿æ€§å¸§ç¼“å†²ï¼ˆæ˜¾å­˜ï¼‰                            â”‚  â”‚
â”‚   â”‚        ç‰©ç†åœ°å€ç”± Multiboot ä¿¡æ¯æä¾›                      â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¾“å‡ºè·¯å¾„å¯¹æ¯”

| åœºæ™¯ | VGA æ–‡æœ¬æ¨¡å¼ | å›¾å½¢æ¨¡å¼ |
|------|-------------|---------|
| å†…æ ¸ kprintf | vga_putchar() | fb_terminal_putchar() |
| å†…æ ¸ shell é¢œè‰² | vga_set_color() | fb_terminal_set_vga_color() |
| ç”¨æˆ·æ€ print() | devconsole â†’ vga_putchar() | devconsole â†’ fb_terminal_putchar() |
| ANSI é¢œè‰² | ä¸æ”¯æŒ | fb_handle_sgr() |

---

## å·²å®ç°åŠŸèƒ½è¯¦è§£

### 1. PCI æ€»çº¿é©±åŠ¨

**æ–‡ä»¶**ï¼š
- `src/include/drivers/pci.h`
- `src/drivers/pci.c`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š

```c
// é…ç½®ç©ºé—´è®¿é—®
uint32_t pci_read_config32(uint8_t bus, uint8_t slot, uint8_t func, uint8_t offset);
void pci_write_config32(uint8_t bus, uint8_t slot, uint8_t func, uint8_t offset, uint32_t value);

// è®¾å¤‡æšä¸¾
int pci_scan_devices(void);
pci_device_t *pci_find_device(uint16_t vendor_id, uint16_t device_id);
pci_device_t *pci_find_class(uint8_t class_code, uint8_t subclass);

// BAR è§£æ
uint32_t pci_get_bar_address(pci_device_t *dev, int bar_index);
uint32_t pci_get_bar_size(pci_device_t *dev, int bar_index);

// è®¾å¤‡æ§åˆ¶
void pci_enable_bus_master(pci_device_t *dev);
void pci_enable_memory_space(pci_device_t *dev);
```

**Shell å‘½ä»¤**ï¼š
- `lspci` - åˆ—å‡ºæ‰€æœ‰ PCI è®¾å¤‡

### 2. å¸§ç¼“å†²é©±åŠ¨

**æ–‡ä»¶**ï¼š
- `src/include/drivers/framebuffer.h`
- `src/drivers/framebuffer.c`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š

```c
// åˆå§‹åŒ–ï¼ˆä» Multiboot ä¿¡æ¯ï¼‰
int fb_init(multiboot_info_t *mbi);

// åŸºç¡€ç»˜å›¾
void fb_clear(color_t color);
void fb_put_pixel(int x, int y, color_t color);
void fb_fill_rect(int x, int y, int width, int height, color_t color);
void fb_draw_line(int x1, int y1, int x2, int y2, color_t color);

// æ–‡æœ¬æ¸²æŸ“
void fb_draw_char(int x, int y, char c, color_t fg, color_t bg);
void fb_draw_string(int x, int y, const char *str, color_t fg, color_t bg);

// ç»ˆç«¯ä»¿çœŸ
void fb_terminal_init(void);
void fb_terminal_putchar(char c);    // æ”¯æŒ ANSI è½¬ä¹‰åºåˆ—
void fb_terminal_write(const char *str);
void fb_terminal_set_vga_color(uint8_t fg, uint8_t bg);  // VGA é¢œè‰²å…¼å®¹

// åŒç¼“å†²
void fb_enable_double_buffer(void);
void fb_flush(void);
void fb_flush_all(void);
```

**æ”¯æŒçš„ ANSI è½¬ä¹‰åºåˆ—**ï¼š

| åºåˆ— | åŠŸèƒ½ | ç¤ºä¾‹ |
|------|------|------|
| `\033[m` | SGR é¢œè‰²è®¾ç½® | `\033[31m` çº¢è‰²å‰æ™¯ |
| `\033[2J` | æ¸…å± | `\033[2J\033[H` æ¸…å±å¹¶å½’ä½ |
| `\033[H` | å…‰æ ‡å®šä½ | `\033[10;20H` ç§»åˆ°ç¬¬10è¡Œç¬¬20åˆ— |
| `\033[A/B/C/D` | å…‰æ ‡ç§»åŠ¨ | `\033[5A` ä¸Šç§»5è¡Œ |

**VGA 16 è‰²è°ƒè‰²æ¿æ”¯æŒ**ï¼š

```c
// æ ‡å‡† VGA 16 è‰²æ˜ å°„åˆ° RGB
static const color_t vga_palette[16] = {
    {0, 0, 0, 255},         // 0: BLACK
    {0, 0, 170, 255},       // 1: BLUE
    {0, 170, 0, 255},       // 2: GREEN
    {0, 170, 170, 255},     // 3: CYAN
    {170, 0, 0, 255},       // 4: RED
    {170, 0, 170, 255},     // 5: MAGENTA
    {170, 85, 0, 255},      // 6: BROWN
    {170, 170, 170, 255},   // 7: LIGHT_GREY
    {85, 85, 85, 255},      // 8: DARK_GREY
    {85, 85, 255, 255},     // 9: LIGHT_BLUE
    {85, 255, 85, 255},     // 10: LIGHT_GREEN
    {85, 255, 255, 255},    // 11: LIGHT_CYAN
    {255, 85, 85, 255},     // 12: LIGHT_RED
    {255, 85, 255, 255},    // 13: LIGHT_MAGENTA
    {255, 255, 85, 255},    // 14: YELLOW
    {255, 255, 255, 255}    // 15: WHITE
};
```

### 3. æ€§èƒ½ä¼˜åŒ–

#### PAT Write-Combining æ”¯æŒ

**æ–‡ä»¶**ï¼š
- `src/mm/vmm.c` - `vmm_init_pat()`, `vmm_map_framebuffer()`
- `src/include/mm/vmm.h`

**åŸç†**ï¼š

å¸§ç¼“å†²å†…å­˜ä½¿ç”¨ Write-Combining (WC) ç¼“å­˜æ¨¡å¼ï¼Œå…è®¸ CPU å°†å¤šä¸ªè¿ç»­çš„åƒç´ å†™å…¥åˆå¹¶ä¸ºä¸€ä¸ªå¤§çš„å†™æ“ä½œï¼Œå¤§å¹…æå‡å†™å…¥æ€§èƒ½ã€‚

```c
// PAT åˆå§‹åŒ–ï¼ˆåœ¨ vmm_init åè°ƒç”¨ï¼‰
void vmm_init_pat(void);

// å¸§ç¼“å†²ä¸“ç”¨æ˜ å°„ï¼ˆä½¿ç”¨ WC æ¨¡å¼ï¼‰
uint32_t vmm_map_framebuffer(uint32_t phys_addr, uint32_t size);
```

**PAT é…ç½®**ï¼š
```
PAT[0] = WB  (Write-Backï¼Œæ™®é€šå†…å­˜)
PAT[1] = WT  (Write-Through)
PAT[2] = UC- (Uncacheable)
PAT[3] = UC  (Uncacheable)
PAT[4] = WB  (Write-Back)
PAT[5] = WT  (Write-Through)
PAT[6] = UC- (Uncacheable)
PAT[7] = WC  (Write-Combiningï¼Œç”¨äºå¸§ç¼“å†²) â† ä½¿ç”¨æ­¤æ¨¡å¼
```

#### è½¯ä»¶åŒç¼“å†²

**åŸç†**ï¼š

åœ¨æ™®é€šå†…å­˜ï¼ˆWB æ¨¡å¼ï¼‰ä¸­ç»´æŠ¤åå¤‡ç¼“å†²åŒºï¼Œæ‰€æœ‰ç»˜åˆ¶æ“ä½œåœ¨åå¤‡ç¼“å†²åŒºè¿›è¡Œã€‚æ»šå±ç­‰éœ€è¦è¯»å–åƒç´ çš„æ“ä½œåœ¨ WB å†…å­˜ä¸­æ‰§è¡Œï¼Œé€Ÿåº¦æå¿«ã€‚å®Œæˆåä¸€æ¬¡æ€§åˆ·æ–°åˆ°æ˜¾å­˜ã€‚

```c
// åŒç¼“å†²å®ç°
static uint8_t *back_buffer_mem = NULL;   // åå¤‡ç¼“å†²åŒºï¼ˆWB å†…å­˜ï¼‰
static bool double_buffering = false;
static int dirty_line_start = -1;          // è„åŒºåŸŸè¿½è¸ª
static int dirty_line_end = -1;

// åˆ·æ–°ç­–ç•¥
void fb_flush(void) {
    // åªåˆ·æ–°è„åŒºåŸŸï¼Œå‡å°‘ä¸å¿…è¦çš„æ˜¾å­˜å†™å…¥
    if (dirty_line_start >= 0 && dirty_line_end >= 0) {
        uint32_t offset = dirty_line_start * fb_info.pitch;
        uint32_t size = (dirty_line_end - dirty_line_start) * fb_info.pitch;
        memcpy(fb_info.buffer + offset, back_buffer_mem + offset, size);
    }
}
```

**è‡ªåŠ¨åˆ·æ–°æ—¶æœº**ï¼š
- æ¢è¡Œæ—¶åˆ·æ–°ï¼ˆç”¨æˆ·èƒ½çœ‹åˆ°è¾“å‡ºï¼‰
- æ»šå±ååˆ·æ–°
- å­—ç¬¦ä¸²è¾“å‡ºå®Œæˆååˆ·æ–°

**æ€§èƒ½å¯¹æ¯”**ï¼š

| æ“ä½œ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| åƒç´ å†™å…¥ | UC æ˜¾å­˜ï¼ˆæ— ç¼“å­˜ï¼‰ | WC æ˜¾å­˜ï¼ˆå†™åˆå¹¶ï¼‰æˆ– WB åå¤‡ç¼“å†²åŒº |
| æ»šå±è¯»å– | UC æ˜¾å­˜ï¼ˆææ…¢ï¼‰ | WB åå¤‡ç¼“å†²åŒºï¼ˆç¼“å­˜å‘½ä¸­ï¼‰ |
| æ»šå±å†™å…¥ | UC æ˜¾å­˜ | WB åå¤‡ç¼“å†²åŒº + æ‰¹é‡åˆ·æ–° |

### 4. EDID æ”¯æŒ

**æ–‡ä»¶**ï¼š
- `src/include/drivers/edid.h`
- `src/drivers/edid.c`

**å·²å®ç°åŠŸèƒ½**ï¼š
- EDID æ•°æ®å—éªŒè¯
- EDID è§£æï¼ˆåˆ¶é€ å•†ã€åˆ†è¾¨ç‡ã€å°ºå¯¸ç­‰ï¼‰
- é¦–é€‰åˆ†è¾¨ç‡æå–

**æœªå®ç°åŠŸèƒ½**ï¼š
- I2C/DDC ç¡¬ä»¶è¯»å–ï¼ˆéœ€è¦æ˜¾å¡ç‰¹å®šçš„ GPIO ä½æ“ä½œï¼‰

```c
// è§£æ EDID æ•°æ®ï¼ˆå·²å®ç°ï¼‰
int edid_parse(const uint8_t *data, edid_info_t *info);
bool edid_validate(const uint8_t *data);
void edid_print_info(const edid_info_t *info);

// ä»ç¡¬ä»¶è¯»å–ï¼ˆæ¡†æ¶å·²å®ç°ï¼ŒI2C ä½æ“ä½œæœªå®ç°ï¼‰
int edid_read_from_radeon(volatile uint32_t *mmio_base, edid_info_t *info);
```

### 5. GRUB é…ç½®

**æ–‡ä»¶**ï¼š`grub.cfg`

```bash
# å¤šåˆ†è¾¨ç‡æ”¯æŒé…ç½®
# GRUB ä¼šæŒ‰é¡ºåºå°è¯•ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªæ”¯æŒçš„åˆ†è¾¨ç‡
set gfxmode=1400x1050x32,1024x768x32,800x600x32,auto
set gfxpayload=keep

# å¯åŠ¨èœå•
menuentry "CastorOS (Auto Resolution)" {
    set gfxpayload=keep
    multiboot /boot/castor.bin
    boot
}

menuentry "CastorOS (1400x1050 SXGA+)" { ... }
menuentry "CastorOS (1024x768 XGA)" { ... }
menuentry "CastorOS (Text Mode)" { ... }
```

### 6. Multiboot å¤´éƒ¨

**æ–‡ä»¶**ï¼š`src/boot/multiboot.asm`

```nasm
; è§†é¢‘æ¨¡å¼å­—æ®µï¼ˆè¯·æ±‚å›¾å½¢æ¨¡å¼ï¼‰
dd 0                            ; mode_type: 0 = çº¿æ€§å›¾å½¢æ¨¡å¼
dd 0                            ; width: 0 = è®© GRUB æ ¹æ® gfxpayload é€‰æ‹©
dd 0                            ; height: 0 = è®© GRUB æ ¹æ® gfxpayload é€‰æ‹©
dd 32                           ; depth: é¦–é€‰ä½æ·±åº¦ï¼ˆ32bppï¼‰
```

---

## å†…æ ¸é›†æˆ

### kernel.c åˆå§‹åŒ–æµç¨‹

```c
void kernel_main(multiboot_info_t* mbi) {
    // ... æ—©æœŸåˆå§‹åŒ– ...
    
    // 3.2 åˆå§‹åŒ– VMM
    vmm_init();
    
    // 3.3 åˆå§‹åŒ– PATï¼ˆç”¨äºå¸§ç¼“å†² Write-Combiningï¼‰
    vmm_init_pat();
    
    // ... å…¶ä»–åˆå§‹åŒ– ...
    
    // 4.5 åˆå§‹åŒ– PCI æ€»çº¿
    pci_init();
    pci_scan_devices();
    
    // 4.6 åˆå§‹åŒ–å›¾å½¢é©±åŠ¨
    int fb_result = fb_init(mbi);
    if (fb_result == 0) {
        // å›¾å½¢æ¨¡å¼æˆåŠŸ
        fb_terminal_init();  // åˆå§‹åŒ–ç»ˆç«¯ä»¿çœŸ
        // kprintf è‡ªåŠ¨ä½¿ç”¨ fb_terminal_putchar
    } else {
        // å›é€€åˆ° VGA æ–‡æœ¬æ¨¡å¼
        // kprintf ä½¿ç”¨ vga_putchar
    }
}
```

### kprintf è‡ªåŠ¨åˆ‡æ¢

**æ–‡ä»¶**ï¼š`src/lib/kprintf.c`

```c
static void output_char(char c, output_target_t target) {
    if (target & OUTPUT_VGA) {
        // ä¼˜å…ˆä½¿ç”¨å›¾å½¢ç»ˆç«¯ï¼Œå›é€€åˆ° VGA æ–‡æœ¬æ¨¡å¼
        if (fb_is_initialized()) {
            fb_terminal_putchar(c);
        } else {
            vga_putchar(c);
        }
    }
}
```

### devfs æ§åˆ¶å°è¾“å‡º

**æ–‡ä»¶**ï¼š`src/fs/devfs.c`

```c
static uint32_t devconsole_write(fs_node_t *node, uint32_t offset,
                                 uint32_t size, uint8_t *buffer) {
    for (uint32_t i = 0; i < size; i++) {
        if (fb_is_initialized()) {
            fb_terminal_putchar(buffer[i]);
        } else {
            vga_putchar(buffer[i]);
        }
    }
    return size;
}
```

---

## Shell å‘½ä»¤

| å‘½ä»¤ | æè¿° |
|------|------|
| `lspci` | åˆ—å‡ºæ‰€æœ‰ PCI è®¾å¤‡ |
| `fbinfo` | æ˜¾ç¤ºå¸§ç¼“å†²ä¿¡æ¯ï¼ˆåˆ†è¾¨ç‡ã€é¢œè‰²æ·±åº¦ã€ç‰©ç†åœ°å€ï¼‰|

---

## æŠ€æœ¯èƒŒæ™¯

### IBM ThinkPad T41 æ˜¾å¡è§„æ ¼

**ATI Mobility Radeon 7500** è§„æ ¼ï¼š
- GPU æ¶æ„ï¼šRV200ï¼ˆR200 ç³»åˆ—ç§»åŠ¨ç‰ˆï¼‰
- æ˜¾å­˜ï¼š16MB/32MB DDR SDRAM
- æ ¸å¿ƒé¢‘ç‡ï¼š230-290 MHz
- æ¥å£ï¼šAGP 4x
- æœ€å¤§åˆ†è¾¨ç‡ï¼š2048Ã—1536ï¼ˆå¤–æ¥ï¼‰/ 1400Ã—1050ï¼ˆå†…ç½® LCDï¼‰

**T41 å†…ç½®æ˜¾ç¤ºå±**ï¼š
- å°ºå¯¸ï¼š14.1 è‹±å¯¸
- åˆ†è¾¨ç‡ï¼š1024Ã—768ï¼ˆXGAï¼‰æˆ– 1400Ã—1050ï¼ˆSXGA+ï¼‰
- ç±»å‹ï¼šTFT LCD

### å¸§ç¼“å†²ï¼ˆFramebufferï¼‰æ¦‚å¿µ

**çº¿æ€§å¸§ç¼“å†²**ï¼š
- å±å¹•åƒç´ æŒ‰è¡Œè¿ç»­å­˜å‚¨
- åƒç´ åœ°å€ = åŸºåœ°å€ + y Ã— pitch + x Ã— bytes_per_pixel
- æ— éœ€å¤„ç†å†…å­˜åˆ†é¡µï¼ˆbank switchingï¼‰

**åƒç´ æ ¼å¼**ï¼ˆä»¥ 32bpp ä¸ºä¾‹ï¼‰ï¼š
```
32bpp ARGB (8-8-8-8):
  31-24: Alpha (æˆ–ä¿ç•™)
  23-16: Red
  15-8:  Green
  7-0:   Blue
```

---

## æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

- `src/include/drivers/pci.h` - PCI æ€»çº¿é©±åŠ¨å¤´æ–‡ä»¶
- `src/drivers/pci.c` - PCI æ€»çº¿é©±åŠ¨å®ç°
- `src/include/drivers/framebuffer.h` - å¸§ç¼“å†²é©±åŠ¨å¤´æ–‡ä»¶
- `src/drivers/framebuffer.c` - å¸§ç¼“å†²é©±åŠ¨å®ç°
- `src/include/drivers/edid.h` - EDID è¯»å–é©±åŠ¨å¤´æ–‡ä»¶
- `src/drivers/edid.c` - EDID è¯»å–é©±åŠ¨å®ç°
- `src/include/drivers/font8x16.h` - 8x16 ç‚¹é˜µå­—ä½“æ•°æ®

### ä¿®æ”¹æ–‡ä»¶

- `src/boot/multiboot.asm` - æ·»åŠ å›¾å½¢æ¨¡å¼è¯·æ±‚
- `src/include/kernel/multiboot.h` - æ·»åŠ å¸§ç¼“å†²ç›¸å…³å­—æ®µ
- `src/kernel/kernel.c` - é›†æˆå›¾å½¢åˆå§‹åŒ–
- `src/lib/kprintf.c` - æ·»åŠ å›¾å½¢æ¨¡å¼è¾“å‡ºæ”¯æŒ
- `src/include/lib/kprintf.h` - æ·»åŠ  kconsole_set_color å£°æ˜
- `src/fs/devfs.c` - æ§åˆ¶å°è®¾å¤‡æ”¯æŒå›¾å½¢æ¨¡å¼
- `src/kernel/kernel_shell.c` - shell é¢œè‰²å…¼å®¹å±‚
- `src/mm/vmm.c` - æ·»åŠ  PAT å’Œå¸§ç¼“å†²æ˜ å°„æ”¯æŒ
- `src/include/mm/vmm.h` - æ·»åŠ ç›¸å…³å£°æ˜
- `grub.cfg` - é…ç½®å¤šåˆ†è¾¨ç‡å›¾å½¢æ¨¡å¼
- `Makefile` - æ·»åŠ æ–°æ–‡ä»¶ç¼–è¯‘è§„åˆ™

---

## é™åˆ¶å’Œæœªæ¥æ”¹è¿›

### å½“å‰é™åˆ¶

1. ä»…æ”¯æŒ Multiboot/GRUB æä¾›çš„å›¾å½¢æ¨¡å¼
2. ä¸æ”¯æŒè¿è¡Œæ—¶æ¨¡å¼åˆ‡æ¢
3. ä¸æ”¯æŒç¡¬ä»¶åŠ é€Ÿ
4. å­—ä½“æ¸²æŸ“ç®€å•ï¼ˆæ— æŠ—é”¯é½¿ï¼‰
5. EDID I2C è¯»å–æœªå®ç°ï¼ˆéœ€è¦æ˜¾å¡ç‰¹å®šä»£ç ï¼‰

### æœªæ¥æ”¹è¿›

1. **æ¨¡å¼åˆ‡æ¢**
   - å®ç° V86 æ¨¡å¼è°ƒç”¨ VBE BIOS
   - æ”¯æŒè¿è¡Œæ—¶åˆ†è¾¨ç‡åˆ‡æ¢

2. **ATI åŸç”Ÿé©±åŠ¨**
   - ç›´æ¥æ“ä½œ Radeon å¯„å­˜å™¨
   - å®ç° 2D åŠ é€Ÿï¼ˆçŸ©å½¢å¡«å……ã€ä½å—ä¼ è¾“ï¼‰
   - å®ç°ç¡¬ä»¶å…‰æ ‡

3. **GUI æ¡†æ¶**
   - çª—å£ç®¡ç†å™¨
   - é¼ æ ‡æ”¯æŒ
   - æ§ä»¶åº“

4. **é«˜çº§æ¸²æŸ“**
   - æŠ—é”¯é½¿å­—ä½“ï¼ˆFreeTypeï¼‰
   - Alpha æ··åˆ
   - å›¾ç‰‡æ ¼å¼æ”¯æŒï¼ˆBMPã€PNGï¼‰

---

## å‚è€ƒèµ„æ–™

1. [OSDev - PCI](https://wiki.osdev.org/PCI)
2. [OSDev - VESA Video Modes](https://wiki.osdev.org/VESA_Video_Modes)
3. [OSDev - Drawing In Protected Mode](https://wiki.osdev.org/Drawing_In_Protected_Mode)
4. [Multiboot Specification](https://www.gnu.org/software/grub/manual/multiboot/multiboot.html)
5. [Intel PAT (Page Attribute Table)](https://wiki.osdev.org/Page_Attribute_Table)
6. [ATI Radeon Register Reference](https://www.x.org/docs/AMD/)
