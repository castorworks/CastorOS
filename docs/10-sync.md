# é˜¶æ®µ 10: åŒæ­¥æœºåˆ¶

## æ¦‚è¿°

CastorOS å®ç°äº†ä¸‰ç§æ ¸å¿ƒåŒæ­¥åŸè¯­ï¼šè‡ªæ—‹é”ï¼ˆSpinlockï¼‰ã€äº’æ–¥é”ï¼ˆMutexï¼‰å’Œä¿¡å·é‡ï¼ˆSemaphoreï¼‰ï¼Œç”¨äºåœ¨å¤šä»»åŠ¡ç¯å¢ƒä¸­ä¿æŠ¤å…±äº«èµ„æºï¼Œé˜²æ­¢ç«æ€æ¡ä»¶ã€‚

## ç›®æ ‡

- âœ… **å®ç°è‡ªæ—‹é”ï¼ˆSpinlockï¼‰** - åŸºäºåŸå­æ“ä½œçš„å¿™ç­‰å¾…é”
- âœ… **å®ç°äº’æ–¥é”ï¼ˆMutexï¼‰** - æ”¯æŒé€’å½’å’Œä»»åŠ¡é˜»å¡çš„äº’æ–¥é”
- âœ… **å®ç°ä¿¡å·é‡ï¼ˆSemaphoreï¼‰** - æ”¯æŒè®¡æ•°çš„åŒæ­¥åŸè¯­
- ğŸ”„ **åœ¨å…³é”®ç³»ç»Ÿç»„ä»¶ä¸­åº”ç”¨åŒæ­¥ä¿æŠ¤**
  - âœ… ä»»åŠ¡ç®¡ç† (Task Management)
  - âœ… å†…å­˜ç®¡ç† (PMM, VMM, Heap)
  - âœ… æ–‡ä»¶ç³»ç»Ÿ (VFS Mount/Refcount, RamFS Inode/Dir/File)
  - âœ… VGA é©±åŠ¨ (VGA Driver)
  - âœ… æ–‡ä»¶æè¿°ç¬¦è¡¨ (FD Table)
  - âœ… è®¾å¤‡é©±åŠ¨ (Serial, Keyboard, ATA)
  - âœ… å—è®¾å¤‡æ³¨å†Œè¡¨ (BlockDev Registry)
  - âœ… FAT32 æ–‡ä»¶ç³»ç»Ÿ
  - âœ… DevFS/ProcFS (ç§æœ‰ dirent ç¼“å†²åŒº)
  - âŒ ä¸­æ–­ç®¡ç† (IRQ Registry)

---

## å½“å‰å®ç°

### 1. è‡ªæ—‹é”ï¼ˆSpinlockï¼‰

**ä½ç½®**ï¼š`src/kernel/sync/spinlock.c`ã€`src/include/kernel/sync/spinlock.h`

**å®ç°ç‰¹ç‚¹**ï¼š

```c
typedef struct {
    volatile uint32_t value;  // 0=æœªé”å®š, 1=å·²é”å®š
} spinlock_t;
```

**æ ¸å¿ƒæœºåˆ¶**ï¼š
- **åŸå­æ“ä½œ**ï¼šä½¿ç”¨ x86 `xchg` æŒ‡ä»¤å®ç°åŸå­äº¤æ¢ï¼Œä¿è¯å¤šæ ¸ç¯å¢ƒä¸‹çš„äº’æ–¥è®¿é—®
- **å¿™ç­‰å¾…**ï¼šä½¿ç”¨ `pause` æŒ‡ä»¤ä¼˜åŒ–è‡ªæ—‹ç­‰å¾…ï¼Œé™ä½ CPU åŠŸè€—å¹¶æé«˜æ€§èƒ½
- **ä¸­æ–­ä¿æŠ¤**ï¼šæä¾› `spinlock_lock_irqsave()` å’Œ `spinlock_unlock_irqrestore()` é˜²æ­¢ä¸­æ–­æ­»é”

**API æ¥å£**ï¼š
```c
void spinlock_init(spinlock_t *lock);
void spinlock_lock(spinlock_t *lock);
bool spinlock_try_lock(spinlock_t *lock);
void spinlock_unlock(spinlock_t *lock);
bool spinlock_is_locked(const spinlock_t *lock);
void spinlock_lock_irqsave(spinlock_t *lock, bool *irq_state);
void spinlock_unlock_irqrestore(spinlock_t *lock, bool irq_state);
```

### 2. äº’æ–¥é”ï¼ˆMutexï¼‰

**ä½ç½®**ï¼š`src/kernel/sync/mutex.c`ã€`src/include/kernel/sync/mutex.h`

**å®ç°ç‰¹ç‚¹**ï¼š

```c
typedef struct {
    spinlock_t lock;      // ä¿æŠ¤ mutex å†…éƒ¨çŠ¶æ€çš„è‡ªæ—‹é”
    bool locked;          // æ˜¯å¦å·²é”å®š
    uint32_t owner_pid;   // æ‹¥æœ‰è€…è¿›ç¨‹ ID
    uint32_t recursion;   // é€’å½’è®¡æ•°
} mutex_t;
```

**æ ¸å¿ƒæœºåˆ¶**ï¼š
- **åŸºäº spinlock å®ç°**ï¼šä½¿ç”¨è‡ªæ—‹é”ä¿æŠ¤ mutex å†…éƒ¨çŠ¶æ€
- **é€’å½’æ”¯æŒ**ï¼šåŒä¸€ä»»åŠ¡å¯ä»¥å¤šæ¬¡è·å–åŒä¸€äº’æ–¥é”ï¼ˆé€’å½’è®¡æ•°ï¼‰
- **ä»»åŠ¡é˜»å¡**ï¼šæ— æ³•è·å–é”æ—¶ï¼Œä»»åŠ¡è¿›å…¥ BLOCKED çŠ¶æ€å¹¶ä¸»åŠ¨è°ƒåº¦
- **é˜²æ­¢ Lost Wakeup**ï¼šåœ¨æŒæœ‰è‡ªæ—‹é”çš„æƒ…å†µä¸‹è®¾ç½®ä»»åŠ¡çŠ¶æ€ï¼Œç¡®ä¿ä¸ä¼šä¸¢å¤±å”¤é†’ä¿¡å·

**API æ¥å£**ï¼š
```c
void mutex_init(mutex_t *mutex);
void mutex_lock(mutex_t *mutex);
bool mutex_try_lock(mutex_t *mutex);
void mutex_unlock(mutex_t *mutex);
bool mutex_is_locked(const mutex_t *mutex);
```

### 3. ä¿¡å·é‡ï¼ˆSemaphoreï¼‰

**ä½ç½®**ï¼š`src/kernel/sync/semaphore.c`ã€`src/include/kernel/sync/semaphore.h`

**å®ç°ç‰¹ç‚¹**ï¼š

```c
typedef struct {
    spinlock_t lock;  // ä¿æŠ¤ä¿¡å·é‡å†…éƒ¨çŠ¶æ€çš„è‡ªæ—‹é”
    int32_t count;    // è®¡æ•°å€¼
} semaphore_t;
```

**æ ¸å¿ƒæœºåˆ¶**ï¼š
- **åŸºäº spinlock å®ç°**ï¼šä½¿ç”¨è‡ªæ—‹é”ä¿æŠ¤ä¿¡å·é‡å†…éƒ¨çŠ¶æ€
- **è®¡æ•°è¯­ä¹‰**ï¼šæ”¯æŒå¤šä¸ªèµ„æºçš„åŒæ­¥ç®¡ç†
- **ä»»åŠ¡é˜»å¡**ï¼šå½“è®¡æ•°ä¸º 0 æ—¶ï¼Œç­‰å¾…ä»»åŠ¡è¿›å…¥ BLOCKED çŠ¶æ€
- **æº¢å‡ºä¿æŠ¤**ï¼š`semaphore_signal` æ£€æŸ¥æ•´æ•°æº¢å‡ºï¼ˆINT32_MAXï¼‰

**API æ¥å£**ï¼š
```c
void semaphore_init(semaphore_t *sem, int32_t initial_count);
void semaphore_wait(semaphore_t *sem);
bool semaphore_try_wait(semaphore_t *sem);
void semaphore_signal(semaphore_t *sem);
int32_t semaphore_get_value(semaphore_t *sem);
```

---

## å…³é”®åŒºåŸŸä¿æŠ¤çŠ¶æ€

### 1. ä»»åŠ¡ç®¡ç†ï¼ˆTask Managementï¼‰âœ…

**çŠ¶æ€**ï¼šå·²å®ç°
**é”ç±»å‹**ï¼š`spinlock_t task_lock`
**ä½ç½®**ï¼š`src/kernel/task.c`

ä¿æŠ¤äº†ä»»åŠ¡æ± åˆ†é…ã€å°±ç»ªé˜Ÿåˆ—æ“ä½œå’Œ PID åˆ†é…ã€‚ä½¿ç”¨è‡ªæ—‹é”æ˜¯å› ä¸ºè°ƒåº¦å™¨æœ¬èº«éœ€è¦ç¦ç”¨ä¸­æ–­ï¼Œä¸”ä¸´ç•ŒåŒºéå¸¸çŸ­ã€‚

### 2. å†…å­˜ç®¡ç†ï¼ˆMemory Managementï¼‰âœ…

#### 2.1 ç‰©ç†å†…å­˜ç®¡ç†å™¨ï¼ˆPMMï¼‰âœ…
**çŠ¶æ€**ï¼šå·²å®ç°
**é”ç±»å‹**ï¼š`spinlock_t pmm_lock`
**ä½ç½®**ï¼š`src/mm/pmm.c`

ä¿æŠ¤é¡µå¸§ä½å›¾çš„è®¿é—®ã€‚

#### 2.2 å †å†…å­˜åˆ†é…å™¨ï¼ˆHeapï¼‰âœ… (æœ‰å˜æ›´)
**çŠ¶æ€**ï¼šå·²å®ç°
**é”ç±»å‹**ï¼š`spinlock_t heap_lock` (æ–‡æ¡£åŸå»ºè®® Mutex)
**ä½ç½®**ï¼š`src/mm/heap.c`

**å˜æ›´è¯´æ˜**ï¼šå½“å‰å®ç°ä½¿ç”¨äº† `spinlock` è€Œä¸æ˜¯ `mutex`ã€‚è¿™æ„å‘³ç€ `kmalloc` ä¸èƒ½åœ¨æŒæœ‰é”æœŸé—´ç¡çœ ï¼ˆä¾‹å¦‚ç­‰å¾…ç‰©ç†é¡µï¼‰ï¼Œä¸”å¿…é¡»åœ¨ä¸­æ–­ç¦ç”¨çŠ¶æ€ä¸‹è¿è¡Œã€‚è¿™å¯¹äºå†…æ ¸å †æ¥è¯´é€šå¸¸æ˜¯å¯ä»¥æ¥å—çš„ï¼Œåªè¦ `expand` æ“ä½œè¶³å¤Ÿå¿«ã€‚

#### 2.3 è™šæ‹Ÿå†…å­˜ç®¡ç†å™¨ï¼ˆVMMï¼‰âœ…
**çŠ¶æ€**ï¼šå·²å®ç°
**é”ç±»å‹**ï¼š`spinlock_t vmm_lock`
**ä½ç½®**ï¼š`src/mm/vmm.c`

ä½¿ç”¨å…¨å±€è‡ªæ—‹é”ä¿æŠ¤é¡µè¡¨æ˜ å°„æ“ä½œã€‚

### 3. æ–‡ä»¶ç³»ç»Ÿï¼ˆFile Systemï¼‰âœ…

#### 3.1 VFS æŒ‚è½½è¡¨ âœ…
**çŠ¶æ€**ï¼šå·²å®ç°
**é”ç±»å‹**ï¼š`mutex_t vfs_mount_mutex`
**ä½ç½®**ï¼š`src/fs/vfs.c`

#### 3.2 VFS å¼•ç”¨è®¡æ•° âœ…
**çŠ¶æ€**ï¼šå·²å®ç°
**é”ç±»å‹**ï¼š`mutex_t vfs_refcount_mutex`
**ä½ç½®**ï¼š`src/fs/vfs.c`

ä¿æŠ¤ `vfs_ref_node()` å’Œ `vfs_release_node()` ä¸­çš„èŠ‚ç‚¹å¼•ç”¨è®¡æ•°æ“ä½œï¼Œé˜²æ­¢å¹¶å‘ç«äº‰å¯¼è‡´çš„åŒé‡é‡Šæ”¾æˆ–å¼•ç”¨ä¸¢å¤±ã€‚

#### 3.3 RamFS å®ç° âœ…
- **Inode åˆ†é…** âœ…ï¼š`spinlock_t inode_alloc_lock`
- **ç›®å½•æ“ä½œ** âœ…ï¼š`mutex_t lock` (åœ¨ `ramfs_dir_t` ä¸­)
- **æ–‡ä»¶æ•°æ®è¯»å†™** âœ…ï¼š`mutex_t lock` (åœ¨ `ramfs_file_t` ä¸­)ï¼Œä¿æŠ¤æ–‡ä»¶å†…å®¹è¯»å†™å’Œæ‰©å®¹æ“ä½œã€‚

### 4. VGA é©±åŠ¨ âœ…

**çŠ¶æ€**ï¼šå·²å®ç°
**é”ç±»å‹**ï¼š`spinlock_t vga_lock`
**ä½ç½®**ï¼š`src/drivers/vga.c`

ä¿æŠ¤ VGA æ–‡æœ¬æ¨¡å¼çš„å±å¹•è¾“å‡ºï¼ŒåŒ…æ‹¬å…‰æ ‡ä½ç½®ã€é¢œè‰²å±æ€§å’Œ ANSI è½¬ä¹‰åºåˆ—è§£æçŠ¶æ€ã€‚ä½¿ç”¨ `spinlock_lock_irqsave` é˜²æ­¢ä¸­æ–­ä¸Šä¸‹æ–‡çš„å¹²æ‰°ã€‚

### 5. æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼ˆFD Tableï¼‰âœ…

**çŠ¶æ€**ï¼šå·²å®ç°
**é”ç±»å‹**ï¼š`spinlock_t lock` (åœ¨ `fd_table_t` ç»“æ„ä½“ä¸­)
**ä½ç½®**ï¼š`src/kernel/fd_table.c`ã€`src/include/kernel/fd_table.h`

**å®ç°ç‰¹ç‚¹**ï¼š
- æ¯ä¸ª FD è¡¨æœ‰ç‹¬ç«‹çš„è‡ªæ—‹é”ï¼Œä¿æŠ¤å¹¶å‘çš„ FD åˆ†é…ã€é‡Šæ”¾å’Œå¤åˆ¶æ“ä½œ
- `fd_table_copy()` æŒ‰åœ°å€é¡ºåºåŠ é”ä¸¤ä¸ªè¡¨ï¼Œé¿å…æ­»é”
- `fd_table_free()` åœ¨è§£é”åæ‰§è¡Œ VFS æ“ä½œï¼Œé¿å…åœ¨æŒé”æ—¶è°ƒç”¨å¯èƒ½é˜»å¡çš„æ“ä½œ

**å—ä¿æŠ¤çš„å‡½æ•°**ï¼š
- `fd_table_alloc()` - FD åˆ†é…
- `fd_table_get()` - FD æŸ¥è¯¢
- `fd_table_free()` - FD é‡Šæ”¾
- `fd_table_copy()` - FD è¡¨å¤åˆ¶ï¼ˆç”¨äº forkï¼‰

---

### 6. è®¾å¤‡é©±åŠ¨ï¼ˆDevice Driversï¼‰âœ…

#### 6.1 Serial é©±åŠ¨ âœ…

**çŠ¶æ€**ï¼šå·²å®ç°
**é”ç±»å‹**ï¼š`spinlock_t serial_lock`
**ä½ç½®**ï¼š`src/drivers/serial.c`

**å®ç°ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ `spinlock_lock_irqsave` ä¿æŠ¤ä¸²å£è¾“å‡º
- é˜²æ­¢å¤šæ ¸/ä¸­æ–­å¹¶å‘è¾“å‡ºå¯¼è‡´å­—ç¬¦äº¤é”™
- `serial_print()` æ•´ä½“åŠ é”ï¼Œä¿è¯è¾“å‡ºå®Œæ•´æ€§

**å—ä¿æŠ¤çš„å‡½æ•°**ï¼š
- `serial_putchar()` - å•å­—ç¬¦è¾“å‡º
- `serial_print()` - å­—ç¬¦ä¸²è¾“å‡º

#### 6.2 Keyboard é©±åŠ¨ âœ…

**çŠ¶æ€**ï¼šå·²å®ç°
**é”ç±»å‹**ï¼š`spinlock_t keyboard_lock`
**ä½ç½®**ï¼š`src/drivers/keyboard.c`

**å®ç°ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ `spinlock_lock_irqsave` ä¿æŠ¤ç¼“å†²åŒºå’Œäº‹ä»¶å¤„ç†å™¨
- ä¸­æ–­å¤„ç†ç¨‹åºï¼ˆ`keyboard_callback`ï¼‰åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ `spinlock_lock`
- `keyboard_update_leds()` åœ¨è§£é”åæ‰§è¡Œï¼Œé¿å…æŒé”æ—¶é•¿ç­‰å¾…

**å—ä¿æŠ¤çš„å‡½æ•°**ï¼š
- `buffer_get()` - ä»ç¼“å†²åŒºè¯»å–å­—ç¬¦
- `keyboard_has_key()` - æ£€æŸ¥ç¼“å†²åŒºçŠ¶æ€
- `keyboard_clear_buffer()` - æ¸…ç©ºç¼“å†²åŒº
- `keyboard_register_event_handler()` / `keyboard_unregister_event_handler()` - äº‹ä»¶å¤„ç†å™¨ç®¡ç†
- `keyboard_callback()` - ä¸­æ–­å¤„ç†ï¼ˆå†™å…¥ç¼“å†²åŒºï¼‰

#### 6.3 ATA é©±åŠ¨ âœ…

**çŠ¶æ€**ï¼šå·²å®ç°
**é”ç±»å‹**ï¼š`mutex_t ata_channel_mutex[2]`ï¼ˆæ¯ä¸ªé€šé“ä¸€ä¸ªï¼‰
**ä½ç½®**ï¼š`src/drivers/ata.c`

**å®ç°ç‰¹ç‚¹**ï¼š
- æ¯ä¸ª ATA é€šé“ï¼ˆä¸»é€šé“/æ¬¡é€šé“ï¼‰æœ‰ç‹¬ç«‹çš„ mutex
- ä½¿ç”¨ mutex è€Œé spinlockï¼Œå› ä¸º PIO æ“ä½œè€—æ—¶è¾ƒé•¿
- åŒä¸€é€šé“çš„ä¸»/ä»è®¾å¤‡å…±äº«é”ï¼Œé¿å… I/O å†²çª

**å—ä¿æŠ¤çš„å‡½æ•°**ï¼š
- `ata_blockdev_read()` - å—è®¾å¤‡è¯»å–
- `ata_blockdev_write()` - å—è®¾å¤‡å†™å…¥

---

### 7. å·²å®Œæˆå’Œå¾…å®ç°åŒºåŸŸ

#### 7.1 å—è®¾å¤‡æ³¨å†Œè¡¨ (BlockDev Registry) âœ… å·²å®Œæˆ
- **ä½ç½®**ï¼š`src/fs/blockdev.c`
- **å®ç°**ï¼š
  - æ·»åŠ  `mutex_t blockdev_registry_mutex` ä¿æŠ¤æ³¨å†Œè¡¨æ“ä½œ
  - æ·»åŠ  `spinlock_t blockdev_refcount_lock` ä¿æŠ¤å¼•ç”¨è®¡æ•°æ“ä½œï¼ˆä½¿ç”¨ `spinlock_lock_irqsave`ï¼‰
- **å—ä¿æŠ¤å‡½æ•°**ï¼š
  - `blockdev_register()` / `blockdev_unregister()` - æ³¨å†Œè¡¨æ“ä½œ
  - `blockdev_get_by_name()` - æŸ¥æ‰¾æ“ä½œ
  - `blockdev_retain()` / `blockdev_release()` - å¼•ç”¨è®¡æ•°æ“ä½œ

#### 7.2 FAT32 æ–‡ä»¶ç³»ç»Ÿ âœ… å·²å®Œæˆ
- **ä½ç½®**ï¼š`src/fs/fat32.c`
- **å®ç°**ï¼šåœ¨ `fat32_fs_t` ç»“æ„ä½“ä¸­æ·»åŠ  `mutex_t fs_lock` ä¿æŠ¤æ–‡ä»¶ç³»ç»Ÿçº§åˆ«æ“ä½œ
- **å—ä¿æŠ¤å‡½æ•°**ï¼š
  - `fat32_file_read()` / `fat32_file_write()` - æ–‡ä»¶è¯»å†™
  - `fat32_dir_readdir()` / `fat32_dir_finddir()` - ç›®å½•æ“ä½œ
  - `fat32_dir_create()` / `fat32_dir_mkdir()` / `fat32_dir_unlink()` - ç›®å½•ä¿®æ”¹æ“ä½œ

#### 7.3 DevFS âœ… å·²å®Œæˆ
- **ä½ç½®**ï¼š`src/fs/devfs.c`
- **å®ç°**ï¼šä½¿ç”¨èŠ‚ç‚¹ç§æœ‰çš„ `dirent` ç¼“å†²åŒºæ›¿ä»£é™æ€ `dirent`
- **å®ç°ç»†èŠ‚**ï¼š
  - æ·»åŠ  `devfs_private_t` ç»“æ„ä½“ï¼ŒåŒ…å« `readdir_cache`
  - æ¯ä¸ªè®¾å¤‡èŠ‚ç‚¹å’Œæ ¹ç›®å½•èŠ‚ç‚¹éƒ½æœ‰ç‹¬ç«‹çš„ç§æœ‰æ•°æ®
  - `devfs_readdir()` ä½¿ç”¨èŠ‚ç‚¹çš„ `impl` å­—æ®µè·å–ç§æœ‰ç¼“å†²åŒº

#### 7.4 ProcFS âœ… å·²å®Œæˆ
- **ä½ç½®**ï¼š`src/fs/procfs.c`
- **å®ç°**ï¼š
  - ä½¿ç”¨èŠ‚ç‚¹ç§æœ‰çš„ `dirent` ç¼“å†²åŒºæ›¿ä»£é™æ€ `dirent`
  - **ä¸ä½¿ç”¨å…¨å±€é”**ï¼šå› ä¸ºä¸å†ç¼“å­˜èŠ‚ç‚¹ï¼Œæ— éœ€ `procfs_lock`
- **å®ç°ç»†èŠ‚**ï¼š
  - æ·»åŠ  `procfs_private_t` ç»“æ„ä½“ï¼ŒåŒ…å« `readdir_cache`
  - `procfs_root_readdir()` å’Œ `procfs_pid_readdir()` ä½¿ç”¨èŠ‚ç‚¹ç§æœ‰ç¼“å†²åŒº
  - **ä¸å†ç¼“å­˜ pid ç›®å½•å’Œ status æ–‡ä»¶èŠ‚ç‚¹**ï¼šæ¯æ¬¡è¯·æ±‚æ—¶åŠ¨æ€åˆ›å»ºï¼Œç”± VFS å¼•ç”¨è®¡æ•°æœºåˆ¶ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
- **è®¾è®¡è¯´æ˜**ï¼šç§»é™¤äº†èŠ‚ç‚¹ç¼“å­˜ï¼ˆ`proc_dirs`/`proc_status_files` æ•°ç»„ï¼‰ï¼Œé¿å…æ‚¬ç©ºæŒ‡é’ˆé—®é¢˜â€”â€”å½“èŠ‚ç‚¹è¢« VFS é‡Šæ”¾åï¼Œæ•°ç»„ä¸­ä»ä¿ç•™æŒ‡å‘å·²é‡Šæ”¾å†…å­˜çš„æŒ‡é’ˆä¼šå¯¼è‡´å†…å­˜æŸåã€‚ç”±äºä¸å†æœ‰å…±äº«çš„å¯å˜çŠ¶æ€ï¼Œå› æ­¤ä¸éœ€è¦åŒæ­¥é”ä¿æŠ¤

#### 7.5 å·²å®Œæˆï¼šä¸­æ–­ç®¡ç† (IRQ) âœ…
- **ä½ç½®**ï¼š`src/kernel/irq.c`
- **ä¿æŠ¤å¯¹è±¡**ï¼š`irq_handlers[16]` æ•°ç»„
- **é”ç±»å‹**ï¼š`spinlock_t irq_registry_lock` + IRQ save
- **å®ç°ç»†èŠ‚**ï¼š
  - `irq_register_handler()` ä½¿ç”¨ `spinlock_lock_irqsave()` ä¿æŠ¤å†™æ“ä½œ
  - `irq_handler()` åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œä¸­æ–­å·²ç¦ç”¨ï¼Œè¯»å–ä¸éœ€è¦é¢å¤–ä¿æŠ¤
  - é”åœ¨ `irq_init()` ä¸­åˆå§‹åŒ–

---

## åŒæ­¥ä¿æŠ¤å®ç°æ€»ç»“

| ç»„ä»¶ | çŠ¶æ€ | é”ç±»å‹ | è¯´æ˜ |
|------|------|--------|------|
| FAT32 | âœ… å·²å®Œæˆ | `mutex_t fs_lock` (per-fs) | ä¿æŠ¤æ–‡ä»¶ç³»ç»Ÿçº§åˆ«æ“ä½œ |
| BlockDev | âœ… å·²å®Œæˆ | `mutex_t` + `spinlock_t` | æ³¨å†Œè¡¨ç”¨ mutexï¼Œå¼•ç”¨è®¡æ•°ç”¨ spinlock |
| DevFS | âœ… å·²å®Œæˆ | ç§æœ‰ dirent ç¼“å†²åŒº | é¿å…é™æ€å˜é‡ç«äº‰ |
| ProcFS | âœ… å·²å®Œæˆ | ç§æœ‰ dirent ç¼“å†²åŒº | ä¸å†ç¼“å­˜èŠ‚ç‚¹ï¼Œæ¯æ¬¡åŠ¨æ€åˆ›å»ºï¼Œé¿å…æ‚¬ç©ºæŒ‡é’ˆ |
| IRQ Registry | âœ… å·²å®Œæˆ | `spinlock_t` + IRQ save | ä¿æŠ¤ `irq_handlers` æ•°ç»„çš„æ³¨å†Œæ“ä½œ |

---

## åŒæ­¥æœºåˆ¶ä½¿ç”¨æŒ‡å—

### é€‰æ‹©æ­£ç¡®çš„åŒæ­¥åŸè¯­

| åœºæ™¯ | æ¨èåŸè¯­ | åŸå›  |
|------|----------|------|
| çŸ­ä¸´ç•ŒåŒºï¼ˆ< 1Î¼sï¼‰ | Spinlock | é¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ |
| é•¿ä¸´ç•ŒåŒºï¼ˆ> 1msï¼‰ | Mutex | é¿å…æµªè´¹ CPU |
| ä¸­æ–­ä¸Šä¸‹æ–‡ | Spinlock | Mutex ä¸èƒ½åœ¨ä¸­æ–­ä¸­ä½¿ç”¨ |
| å¯èƒ½ç¡çœ çš„ä»£ç  | Mutex | Spinlock ä¸èƒ½ç¡çœ  |
| èµ„æºè®¡æ•° | Semaphore | æ”¯æŒå¤šä¸ªèµ„æº |
| äº‹ä»¶é€šçŸ¥ | Semaphore | åˆå§‹åŒ–ä¸º 0 |

### å„ç»„ä»¶æ¨èçš„é”ç±»å‹

| ç»„ä»¶ç±»å‹ | æ¨èåŸè¯­ | è¯´æ˜ |
|----------|----------|------|
| è®¾å¤‡é©±åŠ¨ï¼ˆä¸­æ–­ç›¸å…³ï¼‰ | Spinlock + IRQ save | å¦‚ Keyboardã€Serialï¼Œéœ€è¦åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ä½¿ç”¨ |
| è®¾å¤‡é©±åŠ¨ï¼ˆé•¿æ—¶é—´ I/Oï¼‰ | Mutex | å¦‚ ATAï¼ŒPIO æ“ä½œè€—æ—¶è¾ƒé•¿ |
| æ–‡ä»¶ç³»ç»Ÿæ“ä½œ | Mutex | å¯èƒ½æ¶‰åŠç£ç›˜ I/Oï¼Œæ“ä½œæ—¶é—´è¾ƒé•¿ |
| å†…å­˜ç®¡ç† | Spinlock | ä¸´ç•ŒåŒºçŸ­ï¼Œä¸”å¯èƒ½åœ¨ä¸­æ–­ä¸­ä½¿ç”¨ |
| å¼•ç”¨è®¡æ•° | åŸå­æ“ä½œæˆ– Spinlock | æ“ä½œç®€å•ï¼Œä½†é¢‘ç¹è°ƒç”¨ |
| æ³¨å†Œè¡¨/å…¨å±€æ•°ç»„ | Mutex æˆ– Spinlock | æ ¹æ®è®¿é—®é¢‘ç‡å’Œä¸´ç•ŒåŒºé•¿åº¦é€‰æ‹© |

### è°ƒè¯•æŠ€å·§

åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¦‚æœé‡åˆ°æ­»é”æˆ–ç«äº‰é—®é¢˜ï¼Œå¯ä»¥æ£€æŸ¥ï¼š
1. **é”é¡ºåº**ï¼šæ˜¯å¦æ€»æ˜¯ä»¥ç›¸åŒçš„é¡ºåºè·å–å¤šä¸ªé”ï¼Ÿ
2. **ä¸­æ–­çŠ¶æ€**ï¼šåœ¨ä¸­æ–­å¤„ç†ç¨‹åºä¸­æ˜¯å¦ä½¿ç”¨äº† Mutexï¼ˆé”™è¯¯ï¼‰ï¼Ÿ
3. **æŒé”ç¡çœ **ï¼šæ˜¯å¦åœ¨æŒæœ‰ Spinlock æ—¶è°ƒç”¨äº†å¯èƒ½ç¡çœ çš„å‡½æ•°ï¼ˆå¦‚ `kmalloc` è§¦å‘ `task_schedule`ï¼Œè™½ç„¶ç›®å‰ `kmalloc` æ˜¯è‡ªæ—‹é”ç‰ˆæœ¬ï¼Œä½†åœ¨å…¶ä»– OS ä¸­è¦æ³¨æ„ï¼‰ï¼Ÿ
4. **é™æ€å˜é‡**ï¼šå‡½æ•°ä¸­çš„ `static` å˜é‡åœ¨å¤šä»»åŠ¡ç¯å¢ƒä¸‹æ˜¯å¦å®‰å…¨ï¼Ÿç‰¹åˆ«æ˜¯ `readdir()` è¿”å›çš„ `struct dirent`ã€‚

### å¸¸è§é™·é˜±

1. **é™æ€ dirent é—®é¢˜**ï¼šå¾ˆå¤šæ–‡ä»¶ç³»ç»Ÿå®ç°ä¸­ `readdir()` è¿”å›æŒ‡å‘é™æ€ `struct dirent` çš„æŒ‡é’ˆï¼Œè¿™åœ¨å¤šä»»åŠ¡ç¯å¢ƒä¸‹æ˜¯ä¸å®‰å…¨çš„ã€‚åº”æ”¹ä¸ºä½¿ç”¨èŠ‚ç‚¹ç§æœ‰çš„ç¼“å†²åŒºã€‚

2. **å¼•ç”¨è®¡æ•°ç«äº‰**ï¼šç®€å•çš„ `ref_count++` ä¸æ˜¯åŸå­æ“ä½œï¼Œåœ¨å¤šæ ¸ç¯å¢ƒä¸‹å¯èƒ½å¯¼è‡´å¼•ç”¨è®¡æ•°é”™è¯¯ã€‚åº”ä½¿ç”¨åŸå­æ“ä½œæˆ–é”ä¿æŠ¤ã€‚

3. **ä¸­æ–­ä¸Šä¸‹æ–‡ä½¿ç”¨ Mutex**ï¼šMutex çš„ `lock()` å¯èƒ½å¯¼è‡´ä»»åŠ¡é˜»å¡ï¼Œåœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ä¼šå¯¼è‡´å†…æ ¸å´©æºƒã€‚ä¸­æ–­ä¸Šä¸‹æ–‡åªèƒ½ä½¿ç”¨ Spinlockã€‚

4. **åµŒå¥—é”å¯¼è‡´æ­»é”**ï¼šå¦‚æœå‡½æ•° A æŒæœ‰é” X å¹¶è°ƒç”¨å‡½æ•° Bï¼Œè€Œå‡½æ•° B ä¹Ÿå°è¯•è·å–é” Xï¼Œå¦‚æœé”ä¸æ”¯æŒé€’å½’ï¼Œåˆ™ä¼šæ­»é”ã€‚Mutex æ”¯æŒé€’å½’ï¼Œä½† Spinlock ä¸æ”¯æŒã€‚
