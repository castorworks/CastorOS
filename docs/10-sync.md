# é˜¶æ®µ 10: åŒæ­¥æœºåˆ¶

## æ¦‚è¿°

CastorOS å®ç°äº†ä¸‰ç§æ ¸å¿ƒåŒæ­¥åŸè¯­ï¼šè‡ªæ—‹é”ï¼ˆSpinlockï¼‰ã€äº’æ–¥é”ï¼ˆMutexï¼‰å’Œä¿¡å·é‡ï¼ˆSemaphoreï¼‰ï¼Œç”¨äºåœ¨å¤šä»»åŠ¡ç¯å¢ƒä¸­ä¿æŠ¤å…±äº«èµ„æºï¼Œé˜²æ­¢ç«æ€æ¡ä»¶ã€‚

## ç›®æ ‡

- âœ… **å®ç°è‡ªæ—‹é”ï¼ˆSpinlockï¼‰** - åŸºäºåŸå­æ“ä½œçš„å¿™ç­‰å¾…é”
- âœ… **å®ç°äº’æ–¥é”ï¼ˆMutexï¼‰** - æ”¯æŒé€’å½’å’Œä»»åŠ¡é˜»å¡çš„äº’æ–¥é”
- âœ… **å®ç°ä¿¡å·é‡ï¼ˆSemaphoreï¼‰** - æ”¯æŒè®¡æ•°çš„åŒæ­¥åŸè¯­
- ğŸ”„ **åœ¨å…³é”®ç³»ç»Ÿç»„ä»¶ä¸­åº”ç”¨åŒæ­¥ä¿æŠ¤**
  - âœ… ä»»åŠ¡ç®¡ç† (Task Management)
  - âœ… å†…å­˜ç®¡ç† (PMM, VMM, Heap)
  - âœ… æ–‡ä»¶ç³»ç»Ÿ (VFS Mount/Refcount, RamFS Inode/Dir/File)
  - âŒ æ–‡ä»¶æè¿°ç¬¦è¡¨ (FD Table)
  - âŒ è®¾å¤‡é©±åŠ¨ (Serial, Keyboard, ATA)
  - âŒ ä¸­æ–­ç®¡ç† (IRQ Registry)

---

## å½“å‰å®ç°

### 1. è‡ªæ—‹é”ï¼ˆSpinlockï¼‰

**ä½ç½®**ï¼š`src/kernel/sync/spinlock.c`ã€`src/include/kernel/sync/spinlock.h`

**å®ç°ç‰¹ç‚¹**ï¼š

```c
typedef struct {
    volatile uint32_t value;  // 0=æœªé”å®š, 1=å·²é”å®š
} spinlock_t;
```

**æ ¸å¿ƒæœºåˆ¶**ï¼š
- **åŸå­æ“ä½œ**ï¼šä½¿ç”¨ x86 `xchg` æŒ‡ä»¤å®ç°åŸå­äº¤æ¢ï¼Œä¿è¯å¤šæ ¸ç¯å¢ƒä¸‹çš„äº’æ–¥è®¿é—®
- **å¿™ç­‰å¾…**ï¼šä½¿ç”¨ `pause` æŒ‡ä»¤ä¼˜åŒ–è‡ªæ—‹ç­‰å¾…ï¼Œé™ä½ CPU åŠŸè€—å¹¶æé«˜æ€§èƒ½
- **ä¸­æ–­ä¿æŠ¤**ï¼šæä¾› `spinlock_lock_irqsave()` å’Œ `spinlock_unlock_irqrestore()` é˜²æ­¢ä¸­æ–­æ­»é”

**API æ¥å£**ï¼š
```c
void spinlock_init(spinlock_t *lock);
void spinlock_lock(spinlock_t *lock);
bool spinlock_try_lock(spinlock_t *lock);
void spinlock_unlock(spinlock_t *lock);
bool spinlock_is_locked(const spinlock_t *lock);
void spinlock_lock_irqsave(spinlock_t *lock, bool *irq_state);
void spinlock_unlock_irqrestore(spinlock_t *lock, bool irq_state);
```

### 2. äº’æ–¥é”ï¼ˆMutexï¼‰

**ä½ç½®**ï¼š`src/kernel/sync/mutex.c`ã€`src/include/kernel/sync/mutex.h`

**å®ç°ç‰¹ç‚¹**ï¼š

```c
typedef struct {
    spinlock_t lock;      // ä¿æŠ¤ mutex å†…éƒ¨çŠ¶æ€çš„è‡ªæ—‹é”
    bool locked;          // æ˜¯å¦å·²é”å®š
    uint32_t owner_pid;   // æ‹¥æœ‰è€…è¿›ç¨‹ ID
    uint32_t recursion;   // é€’å½’è®¡æ•°
} mutex_t;
```

**æ ¸å¿ƒæœºåˆ¶**ï¼š
- **åŸºäº spinlock å®ç°**ï¼šä½¿ç”¨è‡ªæ—‹é”ä¿æŠ¤ mutex å†…éƒ¨çŠ¶æ€
- **é€’å½’æ”¯æŒ**ï¼šåŒä¸€ä»»åŠ¡å¯ä»¥å¤šæ¬¡è·å–åŒä¸€äº’æ–¥é”ï¼ˆé€’å½’è®¡æ•°ï¼‰
- **ä»»åŠ¡é˜»å¡**ï¼šæ— æ³•è·å–é”æ—¶ï¼Œä»»åŠ¡è¿›å…¥ BLOCKED çŠ¶æ€å¹¶ä¸»åŠ¨è°ƒåº¦
- **é˜²æ­¢ Lost Wakeup**ï¼šåœ¨æŒæœ‰è‡ªæ—‹é”çš„æƒ…å†µä¸‹è®¾ç½®ä»»åŠ¡çŠ¶æ€ï¼Œç¡®ä¿ä¸ä¼šä¸¢å¤±å”¤é†’ä¿¡å·

**API æ¥å£**ï¼š
```c
void mutex_init(mutex_t *mutex);
void mutex_lock(mutex_t *mutex);
bool mutex_try_lock(mutex_t *mutex);
void mutex_unlock(mutex_t *mutex);
bool mutex_is_locked(const mutex_t *mutex);
```

### 3. ä¿¡å·é‡ï¼ˆSemaphoreï¼‰

**ä½ç½®**ï¼š`src/kernel/sync/semaphore.c`ã€`src/include/kernel/sync/semaphore.h`

**å®ç°ç‰¹ç‚¹**ï¼š

```c
typedef struct {
    spinlock_t lock;  // ä¿æŠ¤ä¿¡å·é‡å†…éƒ¨çŠ¶æ€çš„è‡ªæ—‹é”
    int32_t count;    // è®¡æ•°å€¼
} semaphore_t;
```

**æ ¸å¿ƒæœºåˆ¶**ï¼š
- **åŸºäº spinlock å®ç°**ï¼šä½¿ç”¨è‡ªæ—‹é”ä¿æŠ¤ä¿¡å·é‡å†…éƒ¨çŠ¶æ€
- **è®¡æ•°è¯­ä¹‰**ï¼šæ”¯æŒå¤šä¸ªèµ„æºçš„åŒæ­¥ç®¡ç†
- **ä»»åŠ¡é˜»å¡**ï¼šå½“è®¡æ•°ä¸º 0 æ—¶ï¼Œç­‰å¾…ä»»åŠ¡è¿›å…¥ BLOCKED çŠ¶æ€
- **æº¢å‡ºä¿æŠ¤**ï¼š`semaphore_signal` æ£€æŸ¥æ•´æ•°æº¢å‡ºï¼ˆINT32_MAXï¼‰

**API æ¥å£**ï¼š
```c
void semaphore_init(semaphore_t *sem, int32_t initial_count);
void semaphore_wait(semaphore_t *sem);
bool semaphore_try_wait(semaphore_t *sem);
void semaphore_signal(semaphore_t *sem);
int32_t semaphore_get_value(semaphore_t *sem);
```

---

## å…³é”®åŒºåŸŸä¿æŠ¤çŠ¶æ€

### 1. ä»»åŠ¡ç®¡ç†ï¼ˆTask Managementï¼‰âœ…

**çŠ¶æ€**ï¼šå·²å®ç°
**é”ç±»å‹**ï¼š`spinlock_t task_lock`
**ä½ç½®**ï¼š`src/kernel/task.c`

ä¿æŠ¤äº†ä»»åŠ¡æ± åˆ†é…ã€å°±ç»ªé˜Ÿåˆ—æ“ä½œå’Œ PID åˆ†é…ã€‚ä½¿ç”¨è‡ªæ—‹é”æ˜¯å› ä¸ºè°ƒåº¦å™¨æœ¬èº«éœ€è¦ç¦ç”¨ä¸­æ–­ï¼Œä¸”ä¸´ç•ŒåŒºéå¸¸çŸ­ã€‚

### 2. å†…å­˜ç®¡ç†ï¼ˆMemory Managementï¼‰âœ…

#### 2.1 ç‰©ç†å†…å­˜ç®¡ç†å™¨ï¼ˆPMMï¼‰âœ…
**çŠ¶æ€**ï¼šå·²å®ç°
**é”ç±»å‹**ï¼š`spinlock_t pmm_lock`
**ä½ç½®**ï¼š`src/mm/pmm.c`

ä¿æŠ¤é¡µå¸§ä½å›¾çš„è®¿é—®ã€‚

#### 2.2 å †å†…å­˜åˆ†é…å™¨ï¼ˆHeapï¼‰âœ… (æœ‰å˜æ›´)
**çŠ¶æ€**ï¼šå·²å®ç°
**é”ç±»å‹**ï¼š`spinlock_t heap_lock` (æ–‡æ¡£åŸå»ºè®® Mutex)
**ä½ç½®**ï¼š`src/mm/heap.c`

**å˜æ›´è¯´æ˜**ï¼šå½“å‰å®ç°ä½¿ç”¨äº† `spinlock` è€Œä¸æ˜¯ `mutex`ã€‚è¿™æ„å‘³ç€ `kmalloc` ä¸èƒ½åœ¨æŒæœ‰é”æœŸé—´ç¡çœ ï¼ˆä¾‹å¦‚ç­‰å¾…ç‰©ç†é¡µï¼‰ï¼Œä¸”å¿…é¡»åœ¨ä¸­æ–­ç¦ç”¨çŠ¶æ€ä¸‹è¿è¡Œã€‚è¿™å¯¹äºå†…æ ¸å †æ¥è¯´é€šå¸¸æ˜¯å¯ä»¥æ¥å—çš„ï¼Œåªè¦ `expand` æ“ä½œè¶³å¤Ÿå¿«ã€‚

#### 2.3 è™šæ‹Ÿå†…å­˜ç®¡ç†å™¨ï¼ˆVMMï¼‰âœ…
**çŠ¶æ€**ï¼šå·²å®ç°
**é”ç±»å‹**ï¼š`spinlock_t vmm_lock`
**ä½ç½®**ï¼š`src/mm/vmm.c`

ä½¿ç”¨å…¨å±€è‡ªæ—‹é”ä¿æŠ¤é¡µè¡¨æ˜ å°„æ“ä½œã€‚

### 3. æ–‡ä»¶ç³»ç»Ÿï¼ˆFile Systemï¼‰âœ…

#### 3.1 VFS æŒ‚è½½è¡¨ âœ…
**çŠ¶æ€**ï¼šå·²å®ç°
**é”ç±»å‹**ï¼š`mutex_t vfs_mount_mutex`
**ä½ç½®**ï¼š`src/fs/vfs.c`

#### 3.2 VFS å¼•ç”¨è®¡æ•° âœ…
**çŠ¶æ€**ï¼šå·²å®ç°
**é”ç±»å‹**ï¼š`mutex_t vfs_refcount_mutex`
**ä½ç½®**ï¼š`src/fs/vfs.c`

ä¿æŠ¤ `vfs_ref_node()` å’Œ `vfs_release_node()` ä¸­çš„èŠ‚ç‚¹å¼•ç”¨è®¡æ•°æ“ä½œï¼Œé˜²æ­¢å¹¶å‘ç«äº‰å¯¼è‡´çš„åŒé‡é‡Šæ”¾æˆ–å¼•ç”¨ä¸¢å¤±ã€‚

#### 3.3 RamFS å®ç° âœ…
- **Inode åˆ†é…** âœ…ï¼š`spinlock_t inode_alloc_lock`
- **ç›®å½•æ“ä½œ** âœ…ï¼š`mutex_t lock` (åœ¨ `ramfs_dir_t` ä¸­)
- **æ–‡ä»¶æ•°æ®è¯»å†™** âœ…ï¼š`mutex_t lock` (åœ¨ `ramfs_file_t` ä¸­)ï¼Œä¿æŠ¤æ–‡ä»¶å†…å®¹è¯»å†™å’Œæ‰©å®¹æ“ä½œã€‚

### 4. å¾…å®ç°/å®Œå–„åŒºåŸŸ âŒ

ä»¥ä¸‹åŒºåŸŸå°šæœªæ·»åŠ åŒæ­¥ä¿æŠ¤ï¼Œéœ€åœ¨åç»­å¼€å‘ä¸­è¡¥å……ï¼š

#### 4.1 æ–‡ä»¶æè¿°ç¬¦è¡¨ (FD Table)
- **ç°çŠ¶**ï¼šæ— é”ä¿æŠ¤
- **é£é™©**ï¼šå¤šçº¿ç¨‹åŒæ—¶æ‰“å¼€/å…³é—­æ–‡ä»¶å¯èƒ½å¯¼è‡´ FD æ³„æ¼æˆ–å†²çªã€‚

#### 4.2 è®¾å¤‡é©±åŠ¨ (Drivers)
- **Serial**ï¼š`serial_putchar` æ— é”ï¼Œå¤šæ ¸/ä¸­æ–­å¹¶å‘è¾“å‡ºå¯èƒ½å¯¼è‡´å­—ç¬¦äº¤é”™ã€‚
- **Keyboard**ï¼šç¼“å†²åŒºè¯»å†™å­˜åœ¨ç«æ€æ¡ä»¶ï¼ˆä»£ç æ³¨é‡Šå·²ç¡®è®¤ï¼‰ï¼Œéœ€æ·»åŠ  Spinlockã€‚
- **ATA**ï¼šæ— é”ï¼Œå¹¶å‘ç£ç›˜æ“ä½œå¯èƒ½å¯¼è‡´æŒ‡ä»¤å†²çªã€‚

#### 4.3 ä¸­æ–­ç®¡ç† (IRQ)
- **IRQ æ³¨å†Œ**ï¼š`irq_register_handler` æ— é”ã€‚

---

## åŒæ­¥æœºåˆ¶ä½¿ç”¨æŒ‡å—

### é€‰æ‹©æ­£ç¡®çš„åŒæ­¥åŸè¯­

| åœºæ™¯ | æ¨èåŸè¯­ | åŸå›  |
|------|----------|------|
| çŸ­ä¸´ç•ŒåŒºï¼ˆ< 1Î¼sï¼‰ | Spinlock | é¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ |
| é•¿ä¸´ç•ŒåŒºï¼ˆ> 1msï¼‰ | Mutex | é¿å…æµªè´¹ CPU |
| ä¸­æ–­ä¸Šä¸‹æ–‡ | Spinlock | Mutex ä¸èƒ½åœ¨ä¸­æ–­ä¸­ä½¿ç”¨ |
| å¯èƒ½ç¡çœ çš„ä»£ç  | Mutex | Spinlock ä¸èƒ½ç¡çœ  |
| èµ„æºè®¡æ•° | Semaphore | æ”¯æŒå¤šä¸ªèµ„æº |
| äº‹ä»¶é€šçŸ¥ | Semaphore | åˆå§‹åŒ–ä¸º 0 |

### è°ƒè¯•æŠ€å·§

åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¦‚æœé‡åˆ°æ­»é”æˆ–ç«äº‰é—®é¢˜ï¼Œå¯ä»¥æ£€æŸ¥ï¼š
1. **é”é¡ºåº**ï¼šæ˜¯å¦æ€»æ˜¯ä»¥ç›¸åŒçš„é¡ºåºè·å–å¤šä¸ªé”ï¼Ÿ
2. **ä¸­æ–­çŠ¶æ€**ï¼šåœ¨ä¸­æ–­å¤„ç†ç¨‹åºä¸­æ˜¯å¦ä½¿ç”¨äº† Mutexï¼ˆé”™è¯¯ï¼‰ï¼Ÿ
3. **æŒé”ç¡çœ **ï¼šæ˜¯å¦åœ¨æŒæœ‰ Spinlock æ—¶è°ƒç”¨äº†å¯èƒ½ç¡çœ çš„å‡½æ•°ï¼ˆå¦‚ `kmalloc` è§¦å‘ `task_schedule`ï¼Œè™½ç„¶ç›®å‰ `kmalloc` æ˜¯è‡ªæ—‹é”ç‰ˆæœ¬ï¼Œä½†åœ¨å…¶ä»– OS ä¸­è¦æ³¨æ„ï¼‰ï¼Ÿ
